---
title: "Diversification trial analysis"
author: "Jennifer Schmidt"
date: "3/5/2021"
output: html_document
editor_options: 
  chunk_output_type: console
---
# Setup
```{r setup, include=FALSE,warning=F,message=F}
library(geodist)
library(phyloseq)
library(tidyverse)
library(vegan)
library(ggplot2)
library(ggpubr)
library(factoextra)
library(microbiome)
library(grid)
library(gridExtra)
ps16S <- readRDS("tarengge16S.rds")
psITS <- readRDS("tarenggeITS.rds")
shade <- read.csv("data/shade_trees.csv")
soil <- read.csv("data/Soil_results_diversification.csv")

ps16S <- subset_samples(ps16S,Group!="Monoculture")
# remove unused adjacent plot with different soil type

psITS <- subset_samples(psITS,Group!="Monoculture")

# Divide samples into categories for visualization
ps16S_samples <- subset_samples(ps16S,Group=="Diverse-Cacao")
ps16S_divcontrols <- subset_samples(ps16S,Group=="Cacao-Cacao")

psITS_samples <- subset_samples(psITS,Group=="Diverse-Cacao")
psITS_divcontrols <- subset_samples(psITS,Group=="Cacao-Cacao")
```

## Soil physicochemical analysis
First, visualize differences among treatments using principal components analysis.
```{r}
head(soil)
soil <- subset(soil,Group!="Monoculture") # remove unused comparison plot
soil <- soil %>% select(-Rownames,-Group)
datF <- data.frame(sample_data(psITS))
head(datF)
fullsoil <- left_join(datF[,c(7,10:20)],soil,by="Local.Label.y")%>% filter(complete.cases(.$Sand))%>%column_to_rownames("Local.Label.y")


library(factoextra)

fullsoil2 <- fullsoil[complete.cases(fullsoil[,12:33]),]%>%select(-P2O5,-K2O,-CaO,-MgO,-pH_KCl,-P_Olsen)%>%rename(P=P_CitAcExt,pH=pH_H2O,NH4=NH4_N_mg,NO3=NO3_N_mg,Base_saturation=Base_sat,"% C"=C_percent,"% N"=N_percent,"C/N"=C_N,Cations=Total_Cations)
groups <- as.factor(fullsoil2$Group)
nut.pca <- prcomp(fullsoil2[,12:28],scale=TRUE)
fviz_eig(nut.pca) # scree plot

options(ggrepel.max.overlaps = Inf) 
(pcaplot <- fviz_pca_biplot(nut.pca, geom_ind="point",
                            label="var",
                            repel = TRUE,
                col.var = "#696969", # Variables color
                col.ind = groups, # color by groups
             palette = "Pastel1",# Individuals color
             title=NULL,
             ggtheme=theme_minimal())+theme(panel.grid=element_blank())+ labs(col="Group",shape="Group")+scale_shape_manual(values=c(rep(19,8)))+theme(legend.position="bottom"))
ggexport(pcaplot,filename="Fig2_PCA.tiff",height=1200,width=1600,res=300)

```

# Fig S1
Visualize soil properties that differ between treatments
```{r}
library(ggpubr)
# separate out only soil properties
soilplot <- fullsoil[,c(4,12:34)]  
soilplot <- subset(soilplot,soilplot$P_CitAcExt<500) # outlier

# check correlations
res <- as.matrix(cor(soilplot[,2:23], method = "kendall", use = "complete.obs"))
library(corrplot)
corrplot(res,type="upper")

# need to remove highly correlated variables for model selection and plotting
soilplot <- soilplot %>%
  select(-CaO,-MgO,-K2O,-P2O5,-P_Olsen,-pH_KCl,-Total_Cations,-C_N) %>%
  rename("Base saturation"="Base_sat", 
         "% C" = "C_percent","% N" = "N_percent", 
         "NO3-N"="NO3_N_mg","NH4-N"="NH4_N_mg", "P"="P_CitAcExt",
         "pH"="pH_H2O",
         "Silt"="Loam") %>% 
  pivot_longer(cols=2:16,names_to="Parameter")
unique(soilplot$Parameter)
soilplot$Parameter <- factor(soilplot$Parameter,levels=c("Sand","Silt","Clay","% C","% N","CEC","Base saturation","pH","Na","NO3-N","NH4-N","P","K","Ca","Mg"))

soilplot$Group <- factor(soilplot$Group,levels=c("Diverse-Cacao","Cacao-Cacao"))

(suppfig1 <- soilplot%>%
  ggplot(aes(x=Group,y=value))+
  geom_boxplot(aes(col=Group))+theme_bw()+
  facet_wrap(~Parameter,scales="free",ncol=3)+
  scale_color_brewer(palette="Pastel1",drop=F)+
  theme(panel.grid=element_blank())+
  theme(text=element_text(size=14))+
  theme(axis.text.x=element_blank(),axis.title.x=element_blank(),axis.ticks.x=element_blank())+
  theme(axis.title.y=element_blank())+
  stat_compare_means(comparisons=list(c("Diverse-Cacao","Cacao-Cacao")),label="p.signif",vjust=1)+theme(legend.position="bottom"))

ggexport(suppfig1,filename="SuppFig1_Soils.tiff",height=1800,width=1800,res=300)

#means comparison
tableout <- soilplot%>% 
  group_by(Parameter,Group) %>% summarize(mean=mean(value))
```

ANOVA: Effects of shade species on soil properties
```{r}
hist(log(fullsoil$NH4_N_mg)) # need to log-transform for normality
NH4_mod <- lm(log(NH4_N_mg)~Shade_species,fullsoil)
hist(resid(NH4_mod))
summary(aov(NH4_mod)) # p=0.45 NS

hist(fullsoil$NO3_N_mg) # need to log-transform for normality
NO3_mod <- lm(NO3_N_mg~Shade_species,fullsoil)
hist(resid(NO3_mod))
summary(aov(NO3_mod)) # p=0.078 NS

hist(log(fullsoil$P_CitAcExt))
P_mod <- lm(log(P_CitAcExt)~Shade_species,fullsoil)
summary(aov(P_mod)) # p = 0.51 NS

hist(fullsoil$pH_H2O)
hist(sqrt(8-fullsoil$pH_H2O)) # closest to normality of sqrt, cube root, log of constant - x
pH_mod <- lm(sqrt(8-pH_H2O)~Shade_species,fullsoil)
hist(resid(pH_mod))
summary(aov(pH_mod)) # p<0.01**

TukeyHSD(aov(pH_mod)) # banana, red teak, and sengon are significantly different from none, but not from one another
```

## Microbial community analysis
# Fig S2
Comparison of alpha diversity 
```{r}
library(microbiomeutilities)
#richness
sample_data(psITS)$RichnessF <- specnumber(otu_table(psITS),MARGIN=1) # 1=rows, 2=col; samples are rows
# shannon index
sample_data(psITS)$ShannonF <- vegan::diversity(otu_table(psITS), "shannon")
sample_data(psITS)$PielouF <- (sample_data(psITS)$ShannonF/log(sample_data(psITS)$RichnessF))


div <- data.frame(sample_data(psITS)) %>% select("ID","Group","RichnessF","ShannonF","PielouF") %>%
  rename("Shannon Index" = "ShannonF","Pielou Index" = "PielouF","Richness"="RichnessF") %>% pivot_longer(cols=c("Richness","Shannon Index","Pielou Index"),names_to="div")

(divITS <- ggplot(div,aes(x=Group,y=value))+
  geom_boxplot(aes(col=Group))+theme_bw()+
  facet_wrap(~div,scales="free")+
  scale_color_brewer(palette="Pastel1")+
  theme(panel.grid=element_blank())+
  theme(text=element_text(size=10))+
    stat_compare_means(comparisons=list(c("Diverse-Cacao","Cacao-Cacao")),label="p.signif",vjust=1,size=3)+
  theme(axis.text.x=element_blank(),axis.title.x=element_blank(),axis.ticks.x=element_blank())+
  theme(axis.title.y=element_blank())+theme(legend.position="bottom")+theme(legend.title=element_blank()))

# Bacteria
#richness
sample_data(ps16S)$RichnessB <- specnumber(otu_table(ps16S),MARGIN=1)
# shannon index
sample_data(ps16S)$ShannonB <- vegan::diversity(otu_table(ps16S), "shannon")
sample_data(ps16S)$PielouB <- (sample_data(ps16S)$ShannonB/log(sample_data(ps16S)$RichnessB))


divB <- data.frame(sample_data(ps16S)) %>% select("ID","Group","RichnessB","ShannonB","PielouB") %>%
  rename("Shannon Index" = "ShannonB","Pielou Index" = "PielouB","Richness"="RichnessB") %>% pivot_longer(cols=c("Richness","Shannon Index","Pielou Index"),names_to="div")

(div16S <- ggplot(divB,aes(x=Group,y=value))+
  geom_boxplot(aes(col=Group))+theme_bw()+
  facet_wrap(~div,scales="free")+
  scale_color_brewer(palette="Pastel1")+
  theme(panel.grid=element_blank())+
  theme(text=element_text(size=10))+
  theme(axis.text.x=element_blank(),axis.title.x=element_blank(),axis.ticks.x=element_blank())+stat_compare_means(comparisons=list(c("Diverse-Cacao","Cacao-Cacao")),label="p.signif",vjust=1,size=3)+theme(axis.title.y=element_blank())+theme(legend.position="bottom")+theme(legend.title=element_blank()))

(divplot <- ggarrange(div16S,divITS,ncol=1,labels=c("a","b"),common.legend=TRUE,legend="bottom",font.label=list(size=10)))
ggexport(divplot,filename="FigS2.tiff",width=1200,height=800,res=300)
max(sample_data(psITS)$Richness)
min(sample_data(psITS)$Richness)
```

PCoA: Effect of shade tree presence
```{r}
# based on Bray-Curtis dissimilarity
# log transform microbial communities
ps16Slog <- transform_sample_counts(ps16S, function(x) log(1 + x))
out.pcoa.logB <- ordinate(ps16Slog,  method = "PCoA", distance = "bray")
evalsB <- out.pcoa.logB$values[,1]

(comp16S <- plot_ordination(ps16Slog, out.pcoa.logB, color = "Group") +
  labs(col = "Group")+ theme_bw()+
  coord_fixed(sqrt(evalsB[2] / evalsB[1]))+
  theme(text=element_text(size=12),axis.title=element_text(size=12),legend.title=element_blank(),plot.title=element_blank())+
  scale_color_brewer(palette="Pastel1")+
  theme(panel.grid=element_blank())+theme(legend.position="bottom"))

# Fungi
psITSlog <- transform_sample_counts(psITS, function(x) log(1 + x))
out.pcoa.logF <- ordinate(psITSlog,  method = "PCoA", distance = "bray")
evalsF <- out.pcoa.logF$values[,1]

(compITS <- plot_ordination(psITSlog, out.pcoa.logF, color = "Group") +
  labs(col = "Group")+ theme_bw()+
  coord_fixed(sqrt(evalsF[2] / evalsF[1]))+
  theme(text=element_text(size=12),axis.title=element_text(size=12),legend.title=element_blank(),plot.title=element_blank())+
  scale_color_brewer(palette="Pastel1")+
  theme(panel.grid=element_blank())+theme(legend.position="bottom"))
```

# Fig 3
PCoA: Effect of shade tree species
```{r}
ps16Slog <- transform_sample_counts(ps16S, function(x) log(1 + x))
out.pcoa.logB <- ordinate(ps16Slog,  method = "PCoA", distance = "bray")
evalsB <- out.pcoa.logB_samples$values[,1]
(shade16S <- plot_ordination(ps16Slog, out.pcoa.logB, color = "Shade_species") +
 theme_bw()+
  coord_fixed(sqrt(evalsB[2] / evalsB[1]))+
  theme(plot.title=element_blank())+
  scale_color_brewer(palette="BrBG")+
  theme(panel.grid=element_blank())+theme(legend.position = "bottom")+guides(col=guide_legend(ncol=3))+theme(legend.title=element_blank()))

#ANOSIM is robust to unequal group sizes unlike PERMANOVA
anosim(data.frame(otu_table(ps16S_samples)), sample_data(ps16S_samples)$Shade_species, permutations = 999, distance = "jaccard", strata = NULL) # bray p = 0.537, jaccard 0.536
 
# Fungi
psITSlog <- transform_sample_counts(psITS, function(x) log(1 + x))
out.pcoa.logF <- ordinate(psITSlog,  method = "PCoA", distance = "bray")
evalsF <- out.pcoa.logF$values[,1]
(shadeITS <- plot_ordination(psITSlog, out.pcoa.logF, color = "Shade_species") +
   theme_bw()+
  coord_fixed(sqrt(evalsF[2] / evalsF[1]))+
  theme(text=element_text(size=12),axis.title=element_text(size=12),plot.title=element_blank())+
  scale_color_brewer(palette="BrBG")+
  theme(panel.grid=element_blank())+theme(legend.position = "bottom")+theme(legend.title=element_blank())+guides(col=guide_legend(ncol=3)))

#ANOSIM 
anosim(data.frame(otu_table(psITS_samples)), sample_data(psITS_samples)$Shade_species, permutations = 999, distance = "bray", strata = NULL) # NS for both

fig3 <- ggarrange(shade16S,shadeITS,ncol=2,common.legend=T,legend="bottom",labels="auto",font.label=list(size=12))
ggexport(fig3,filename="Fig3_PCoA.tiff",width=1400,height=800,res=300)
```

## Distance-decay relationships
To assess distance-decay relationships (i.e. does dissimilarity between microbial communities increase with increasing geographic distance), we ran Multiple Matrix Regression (Wang et al. 2013). To visualize, we plotted Bray-Curtis distance vs. geographic distance. 

Dissimilarity matrices for geographic distance
```{r }
# Distance is in meters - see geodist vignettes.
site_coordsB <- sample_data(ps16S) %>% data.frame() %>% select(Longitude,Latitude,Group) 
distgeoB <- geodist(site_coordsB[,c(1:2)],measure="geodesic") # geodesic distance
max(distgeoB,na.rm=T) # max distance between samples ~115m 
hist(distgeoB)

distgeoB_samples <- subset(site_coordsB,Group=="Diversification") %>% geodist(measure="geodesic")
hist(distgeoB_samples)
max(distgeoB_samples,na.rm=T) # only 86m within samples
distgeoB_divcontrols <- subset(site_coordsB,Group=="Diversification Control") %>% geodist(measure="geodesic")
distgeoB_controls <- subset(site_coordsB,Group=="Monoculture") %>% geodist(measure="geodesic")


# Fungi
site_coordsF <- sample_data(psITS) %>% data.frame() %>% rownames_to_column("rownames") %>% select(rownames,Longitude,Latitude,Group) %>% column_to_rownames("rownames")  

distgeoF <- geodist(site_coordsF,measure="geodesic") # geodesic distance
max(distgeoF,na.rm=T) # checking that it's the same

distgeoF_samples <- subset(site_coordsF,Group=="Diversification") %>% geodist(measure="geodesic")
hist(distgeoF_samples)
max(distgeoF_samples,na.rm=T) # 83.5m within samples

distgeoF_divcontrols <- subset(site_coordsF,Group=="Diversification Control") %>% geodist(measure="geodesic")

distgeoF_controls <- subset(site_coordsF,Group=="Monoculture") %>% geodist(measure="geodesic")
```

Bray-Curtis dissimilarity matrices for microbial communities
```{r}
distbrayB_samples=vegdist(data.frame(otu_table(ps16S_samples)), distance="bray")%>%as.matrix()
distbrayF_samples=vegdist(data.frame(otu_table(psITS_samples)), distance="bray")%>%as.matrix()

distbrayB_divcontrols=vegdist(data.frame(otu_table(ps16S_divcontrols)),distance="bray")%>%as.matrix()
distbrayF_divcontrols=vegdist(data.frame(otu_table(psITS_divcontrols)),distance="bray")%>%as.matrix()

distbrayB_controls=vegdist(data.frame(otu_table(ps16S_controls)), distance="bray")%>%as.matrix()
distbrayF_controls=vegdist(data.frame(otu_table(psITS_controls)), distance="bray")%>%as.matrix()
```

Visualization of distance-decay relationships
```{r,echo=FALSE}
distB_samples <- data.frame(Bray=as.vector(distbrayB_samples[upper.tri(distbrayB_samples)]), Geo=as.vector(distgeoB_samples[upper.tri(distgeoB_samples)]),Group="Diversification")

distB_divcontrols <- data.frame(Bray=as.vector(distbrayB_divcontrols[upper.tri(distbrayB_divcontrols)]), Geo=as.vector(distgeoB_divcontrols[upper.tri(distgeoB_divcontrols)]),Group="Diversification Control")

distB_controls <- data.frame(Bray=as.vector(distbrayB_controls[upper.tri(distbrayB_controls)]), Geo=as.vector(distgeoB_controls[upper.tri(distgeoB_controls)]),Group="Monoculture")
distB_all = rbind(distB_samples,distB_divcontrols,distB_controls)
distB_all$Group <- factor(distB_all$Group,levels=c("Diversification","Monoculture","Diversification Control"))

library(grid)
library(gridExtra)
lm1 <- lm(Bray~Geo,distB_samples)
summary(lm1)
grob1 = grobTree(textGrob(paste("y=0.00249x+0.595, ","p=2e-16***" ), x = 0.44, y = 0.47, hjust = 0, gp = gpar(col = "black", fontsize = 11)))

lm2 <- lm(Bray~Geo,distB_controls)
summary(lm2)
grob2 = grobTree(textGrob(paste("NS" ), x = 0.7, y = 0.27, hjust = 0, gp = gpar(col = "black", fontsize = 11)))

lm3 <- lm(Bray~Geo,distB_divcontrols)
summary(lm3)
grob3 = grobTree(textGrob(paste("y=0.00132x+0.685, p=0.00012***"), x = 0.44, y = 0.67, hjust = 0, gp = gpar(col = "black", fontsize = 11)))

(distplotB <- distB_all %>% ggplot(aes(x=Geo,y=Bray))+geom_point(aes(color=Group),alpha=0.2)+geom_smooth(aes(group=Group,color=Group),method="lm",alpha=0.2)+theme_minimal()+theme(panel.grid=element_blank())+labs(x="Geographic distance (m)",y="Bray-Curtis distance",title="Bacteria")+theme(plot.title=element_text(hjust=0.5))+scale_color_brewer(palette="Set2")+theme(legend.position="bottom")+annotation_custom(grob1)+annotation_custom(grob2)+annotation_custom(grob3))

distF_samples <- data.frame(Bray=as.vector(distbrayF_samples[upper.tri(distbrayF_samples)]), Geo=as.vector(distgeoF_samples[upper.tri(distgeoF_samples)]),Group="Diversification") 

distF_divcontrols <- data.frame(Bray=as.vector(distbrayF_divcontrols[upper.tri(distbrayF_divcontrols)]), Geo=as.vector(distgeoF_divcontrols[upper.tri(distgeoF_divcontrols)]),Group="Diversification Control") 

distF_controls <- data.frame(Bray=as.vector(distbrayF_controls[upper.tri(distbrayF_controls)]), Geo=as.vector(distgeoF_controls[upper.tri(distgeoF_controls)]),Group="Monoculture")

distF_all <- rbind(distF_samples,distF_divcontrols,distF_controls)
distF_all$Group <- factor(distF_all$Group,levels=c("Diversification","Monoculture","Diversification Control"))

lm4 <- lm(Bray~Geo,distF_samples)
summary(lm4)
grob4 = grobTree(textGrob(paste("y=0.00173x+0.639, p<2e-16***"), x = 0.4, y = 0.47, hjust = 0, gp = gpar(col = "black", fontsize = 11)))

lm5 <- lm(Bray~Geo,distF_controls)
summary(lm5)
grob5 = grobTree(textGrob(paste("y=0.000971x+0.725, p=0.018*"), x = 0.4, y = 0.75, hjust = 0, gp = gpar(col = "black", fontsize = 11)))

lm6 <- lm(Bray~Geo,distF_divcontrols)
summary(lm6)
grob6 = grobTree(textGrob(paste("y=0.00157x+0.676, p=4.52e-12***"), x = 0.4, y = 0.6, hjust = 0, gp = gpar(col = "black", fontsize = 11)))

(distplotF <- distF_all %>% ggplot(aes(x=Geo,y=Bray))+geom_point(aes(color=Group),alpha=0.2)+geom_smooth(aes(group=Group,color=Group),method="lm",alpha=0.2)+theme_minimal()+theme(panel.grid=element_blank())+labs(x="Geographic distance (m)",y="Bray-Curtis distance",title="Fungi")+theme(plot.title=element_text(hjust=0.5))+scale_color_brewer(palette="Set2")+theme(legend.position="bottom")+annotation_custom(grob4)+annotation_custom(grob5)+annotation_custom(grob6))

library(gridExtra)
grid.arrange(distplotB,distplotF,ncol=2)
```

Multiple matrix regression analysis (MMRR)
Wang et al. (2013) proposed this as an alternative to Mantel tests.
```{r}
# define functions as per Wang et al.
MMRR<-function(Y,X,nperm=999){
	#compute regression coefficients and test statistics
	nrowsY<-nrow(Y)
	y<-unfold(Y)
	if(is.null(names(X)))names(X)<-paste("X",1:length(X),sep="")
        Xmats<-sapply(X,unfold)
        fit<-lm(y~Xmats)
	coeffs<-fit$coefficients
	summ<-summary(fit)
	r.squared<-summ$r.squared
	tstat<-summ$coefficients[,"t value"]
	Fstat<-summ$fstatistic[1]
	tprob<-rep(1,length(tstat))
	Fprob<-1

	#perform permutations
	for(i in 1:nperm){
		rand<-sample(1:nrowsY)
		Yperm<-Y[rand,rand]
		yperm<-unfold(Yperm)
		fit<-lm(yperm~Xmats)
		summ<-summary(fit)
                Fprob<-Fprob+as.numeric(summ$fstatistic[1]>=Fstat)
                tprob<-tprob+as.numeric(abs(summ$coefficients[,"t value"])>=abs(tstat))
	}

	#return values
	tp<-tprob/(nperm+1)
	Fp<-Fprob/(nperm+1)
	names(r.squared)<-"r.squared"
	names(coeffs)<-c("Intercept",names(X))
	names(tstat)<-paste(c("Intercept",names(X)),"(t)",sep="")
	names(tp)<-paste(c("Intercept",names(X)),"(p)",sep="")
	names(Fstat)<-"F-statistic"
	names(Fp)<-"F p-value"
	return(list(r.squared=r.squared,
		coefficients=coeffs,
		tstatistic=tstat,
		tpvalue=tp,
		Fstatistic=Fstat,
		Fpvalue=Fp))
}

# unfold converts the lower diagonal elements of a matrix into a vector
# unfold is called by MMRR

unfold<-function(X){
	x<-vector()
	for(i in 2:nrow(X)) x<-c(x,X[i,1:i-1])
	x<-scale(x, center=TRUE, scale=TRUE)  # Comment this line out if you wish to perform the analysis without standardizing the distance matrices! 
	return(x)
}

# Bacteria
#Make a list of the explanatory (X) matrices
XmatsB <- list(geography=distgeoB_samples)#add soil data when received
distgeoB_samples <- as.matrix(distgeoB_samples)
# Run MMRR function using genetic distance as the response variable and Xmats as the explanatory variables.

MMRR(distbrayB_samples,XmatsB,nperm=999) # p<0.001***, r2=0.254

# repeat for diversification controls
XmatsB <- list(geography=distgeoB_divcontrols)
MMRR(distbrayB_divcontrols,XmatsB,nperm=999) # p=0.003, r2=0.084

# repeat for controls
XmatsB <- list(geography=distgeoB_controls)
MMRR(distbrayB_controls,XmatsB,nperm=999) # p=0.537, r2=0.005

# Fungi
# samples
XmatsF <- list(geography=distgeoF_samples)
MMRR(distbrayF_samples,XmatsF,nperm=999) # r2=0.108,p=0.001

# diversification controls
XmatsF <- list(geography=distgeoF_divcontrols)
MMRR(distbrayF_divcontrols,XmatsF,nperm=999) # r2=0.247,p<0.001

# controls
XmatsF <- list(geography=distgeoF_controls)
MMRR(distbrayF_controls,XmatsF,nperm=999) # NS (p=0.174),r2=0.029
```

# Fig 4
Cacao yields
```{r}
# Dry beans
a <- fullsoil %>% subset(.,complete.cases(fullsoil$Shade_species)) %>% ggplot(aes(x=Shade_species,y=Dry_beans_kg))+geom_point(aes(col=Shade_species))+stat_compare_means(hjust=0.1,vjust=0.5)+theme_bw()+theme(panel.grid=element_blank())+scale_color_brewer(palette="BrBG")+labs(x="Shade species",y="Yield (kg dry beans)")+theme(legend.position = "none")+theme(axis.text.x=element_text(angle=45,hjust=1))

# Healthy pods
b <- fullsoil %>% subset(.,complete.cases(fullsoil$Shade_species)) %>% ggplot(aes(x=Shade_species,y=Harvested_healthy))+geom_point(aes(col=Shade_species))+stat_compare_means(hjust=0.1,vjust=0.5)+theme_bw()+theme(panel.grid=element_blank())+scale_color_brewer(palette="BrBG")+labs(x="Shade species",y="Yield (healthy pods)")+theme(legend.position = "none")+theme(axis.text.x=element_text(angle=45,hjust=1))

# Infected pods
(c <- fullsoil %>%subset(.,complete.cases(fullsoil$Shade_species)) %>% ggplot(aes(x=Shade_species,y=Harvested_infected))+geom_point(aes(col=Shade_species))+stat_compare_means(hjust=0.1,vjust=0.5)+theme_bw()+theme(panel.grid=element_blank())+scale_color_brewer(palette="BrBG")+labs(x="Shade species",y="Yield (infected pods)")+theme(legend.position="none")+theme(axis.text.x=element_text(angle=45,hjust=1)))

fig4 <- ggarrange(a,b,c,ncol=1,labels=c("a","b","c"))
```

## Stepwise Regression
Do any soil properties predict yield?
```{r}
# again, remove highly correlated variables
soilyield <- fullsoil[complete.cases(fullsoil$Dry_beans_kg),c(1:3,12:34)] %>% select(-CaO,-MgO,-K2O,-P2O5,-pH_KCl,-Total_Cations,-C_N)

# first, check variables for outliers - normality is not a requirement for regression, but may need to transform very skewed variables or deal with outliers
colnames(soilyield)
library(tidyverse)
soilyield %>%
  gather() %>% 
  ggplot(aes(value)) +
    facet_wrap(~ key, scales = "free") +
    geom_histogram()
# none of the values seem crazy, perhaps with exception of a single high P value, but a few variables would be better transformed

#hist(log(soilyield$NH4_N_mg))
soilyield$C <- exp(soilyield$C_percent)
soilyield$P <- log(soilyield$P_CitAcExt)
soilyield$CEC_log <- log(soilyield$CEC)
soilyield$K_log <- log(soilyield$K)
soilyield$NH4 <- log(soilyield$NH4_N_mg)

soilyield2 <- soilyield %>% select(-NH4_N_mg,-C_percent,-P_Olsen,-CEC,-K)%>%rename("%C"="C","%N"="N_percent","NO3-N"="NO3_N_mg","pH"="pH_H2O","NH4-N"="NH4","K"="K_log","CEC"="CEC_log","Base saturation"="Base_sat")

library(caret)
# Set seed for reproducibility
set.seed(123)
# Set up repeated k-fold cross-validation
train.control <- trainControl(method = "cv", number = 10)

# Dry beans
step.drybeans <- train(Dry_beans_kg ~., data = soilyield2[,c(3,4:18)],
                    method = "leapSeq", #stepwise
                    tuneGrid = data.frame(nvmax = 1:14),
                    trControl = train.control
                    )
 
summary(step.drybeans$finalModel)


plot(varImp(step.drybeans)) #  No3,Sand,Na,K
importance.dry <- varImp(step.drybeans)$importance %>%rename('Dry Beans'=Overall)
importance <- data.frame(importance.dry)

```

```{r}
step.healthy <- train(Harvested_healthy ~., data = soilyield2[,c(1,4:18)],
                    method = "leapSeq", #stepwise
                    tuneGrid = data.frame(nvmax = 1:14),
                    trControl = train.control
                    )
 
#summary(step.healthy$finalModel) 

plot(varImp(step.healthy)) # No3,P_CitAcExt,Sand,Na
importance.healthy <- varImp(step.healthy)$importance %>%rename(`Healthy Pods`=Overall)
importance[,2] <- importance.healthy
```

```{r}
step.infected <- train(Harvested_infected ~., data = soilyield2[,c(2,4:18)],
                    method = "leapSeq", #stepwise
                    tuneGrid = data.frame(nvmax = 1:14),
                    trControl = train.control
                    )
 
#summary(step.infected$finalModel) #P_CitAcExt

plot(varImp(step.infected)) #  Loam, Mg, P
importance.inf <- varImp(step.infected)$importance %>%rename('Infected Pods'=Overall)
importance[,3] <- importance.inf
```

# Fig 6a: Variable importance heatmap
```{r}
colnames(importance)
importance <- importance %>% rename('Dry Beans'=Dry.Beans)
importance2 <- arrange(importance,rownames(importance))
rownames(importance2)[rownames(importance2) == "Loam"] = "Silt"
mat <- t(importance2)
library(gplots)
tiff(filename='Fig6a.tiff', width=180, height=100,units="mm",res=300)
fig6a <-heatmap.2(x=mat,
          dendrogram="none",
          Rowv = NULL,
          Colv=NULL,
          cexRow=1,cexCol=1,
          margins=c(9,9),
          trace="none",key=TRUE,keysize=2,density.info="none")
graphics.off()
```


Soil - yield correlations
Kendall correlation coefficients (rank-based, non-parametric) were used instead of Pearson correlation coefficient (direct correlation, suitable for normal distributions).
```{r}
# Healthy pods
cor(soilyield2[4:18], soilyield2[2],method="kendall",use="complete.obs")
# highest absolute values for dry beans: N_percent, Sand, Loam,K,Na, none significant
# infected pods: NH4N p=0.049
# healthy pods: N_percent, but not significant
cor.test(soilyield2$Harvested_infected,soilyield2$P,method="kendall",use="complete.obs")


# Correlation plots for significant parameters
library(grid)
library(gridExtra)
grob1 = grobTree(textGrob(paste("Kendall Correlation : ", round(cor(soilyield2$Harvested_infected, soilyield2$NH4,method="kendall"), 3),"p=0.049" ), x = 0.48, y = 0.97, hjust = 0, gp = gpar(col = "red", fontsize = 11, fontface = "bold")))

ggplot(soilyield, aes(x=NH4_N_mg, y=Harvested_infected)) + geom_point() + ggtitle("Infected pods vs. NH4-N") + geom_smooth(method=lm, se=FALSE) + scale_x_continuous(name = "NH4-N") + scale_y_continuous(name = "Infected pods") + theme(plot.title = element_text(hjust = 0.5), panel.background = element_blank(), axis.line = element_line(color="black"), axis.line.x = element_line(color="black"))

ggplot(soilyield, aes(x=NO3_N_mg, y=Dry_beans_kg)) + geom_point() + ggtitle("Dry beans vs. NO3-N") + geom_smooth(method=lm, se=FALSE) + scale_x_continuous(name = "NO3-N") + scale_y_continuous(name = "Dry beans (kg)") + theme(plot.title = element_text(hjust = 0.5), panel.background = element_blank(), axis.line = element_line(color="black"), axis.line.x = element_line(color="black"))


library(ggplot2)
colnames(soilyield)
ggplot(soilyield2, aes(x=NH4, y=Harvested_infected)) + geom_point() + ggtitle("Infected pods vs. NH4-N") + geom_smooth(method=lm, se=FALSE) + scale_x_continuous(name = "NH4-N (log scale)") + scale_y_continuous(name = "Infected pods") + theme(plot.title = element_text(hjust = 0.5), panel.background = element_blank(), axis.line = element_line(color="black"), axis.line.x = element_line(color="black"))+annotation_custom(grob1)
```

Calculate principal components of microbial communities for use in stepwise regression
```{r}
# Add bacterial and fungal PCs (first and second)
library(vegan)
library(phyloseq)
(bactrda <- rda(otu_table(ps16S)))
summary(eigenvals(bactrda)) 

sample_data(ps16S)$PC1B <- scores(bactrda)$sites[,1]
sample_data(ps16S)$PC2B <- scores(bactrda)$sites[,2]

funrda <- rda(otu_table(psITS))
sample_data(psITS)$PC1F <- scores(funrda)$sites[,1]
sample_data(psITS)$PC2F <- scores(funrda)$sites[,2]

PCBs <- data.frame(sample_data(ps16S))%>% select(Local.Label.y,PC1B,PC2B,ShannonB,PielouB,RichnessB)%>%rename("Rownames"="Local.Label.y")
PCFs <- data.frame(sample_data(psITS))%>%select(Local.Label.y,PC1F,PC2F,ShannonF,PielouF,RichnessF)%>%rename("Rownames"="Local.Label.y")
micPCs <- left_join(PCBs,PCFs)

fullsoil2 <- fullsoil %>% select(-Group) %>% rownames_to_column("Rownames")
soilmic <- merge(fullsoil2,micPCs,by="Rownames")%>%
  select(-CaO,-MgO,-K2O,-P2O5,-pH_KCl,-Total_Cations,-C_N,-Local.Label,-Longitude,-Latitude,-Nearest_shade,-Shade_species,-Shade_Longitude,-Shade_Latitude,-Base_sat) %>%
  rename( "NO3-N"="NO3_N_mg", 
         "pH"="pH_H2O",
         "Silt"="Loam","%N"="N_percent")  %>% column_to_rownames("Rownames")
# crazy outlier for fungal communities
soilmic2 <- subset(soilmic,PC1F<140&PC2F<140)

soilmic2 %>%
  gather() %>% 
  ggplot(aes(value)) +
    facet_wrap(~ key, scales = "free") +
    geom_histogram()

# transform skewed variables
soilmic2$`%C` <- exp(soilmic2$C_percent)
soilmic2$P <- log(soilmic2$P_CitAcExt)
soilmic2$K_log <- log(soilmic2$K)
soilmic2$`NH4-N` <- log(soilmic2$NH4_N_mg)

soilmic2 <- soilmic2 %>% select(-K,-NH4_N_mg,-C_percent,-P_Olsen)%>%
  rename("K"="K_log")%>%select(Harvested_healthy,Harvested_infected,Dry_beans_kg,PC1B,PC2B,ShannonB,PielouB,RichnessB,PC1F,PC2F,ShannonF,PielouF,RichnessF,everything())
```


Stepwise regression: What soil properties predict the microbiome?
```{r}
colnames(soilmic2)
library(caret)
step.PC1B <- train(PC1B ~., data = soilmic2[,c(4,14:27)],
                    method = "leapSeq", #stepwise
                    tuneGrid = data.frame(nvmax = 1:13),
                    trControl = train.control)

plot(varImp(step.PC1B)) # pH, Mg, %C,%N
importance.mic <- varImp(step.PC1B)$importance %>%rename(PC1B=Overall)


# PC2B
step.PC2B <- train(PC2B ~., data = soilmic2[,c(5,14:27)],
                    method = "leapSeq", #stepwise
                    tuneGrid = data.frame(nvmax = 1:13),
                    trControl = train.control)

plot(varImp(step.PC2B)) # K, Clay, P
importance.mic[,2] <- varImp(step.PC2B)$importance %>%rename(PC2B=Overall)


# RichnessB
step.RichnessB <- train(RichnessB ~., data = soilmic2[,c(8,14:27)],
                    method = "leapSeq", #stepwise
                    tuneGrid = data.frame(nvmax = 1:13),
                    trControl = train.control)

plot(varImp(step.RichnessB)) # Mg, K, Clay
importance.mic[,3] <- varImp(step.RichnessB)$importance %>%rename(RichnessB=Overall)



# ShannonB
step.ShannonB <- train(ShannonB ~., data = soilmic2[,c(6,14:27)],
                    method = "leapSeq", #stepwise
                    tuneGrid = data.frame(nvmax = 1:13),
                    trControl = train.control)

plot(varImp(step.ShannonB)) # Clay, Mg, Ca
importance.mic[,4] <- varImp(step.ShannonB)$importance %>%rename(ShannonB=Overall)

# PC1F
step.PC1F <- train(PC1F ~., data = soilmic2[,c(9,14:27)],
                    method = "leapSeq", #stepwise
                    tuneGrid = data.frame(nvmax = 1:13),
                    trControl = train.control)
 
summary(step.PC1F$finalModel) #Na

plot(varImp(step.PC1F)) #  Na, Silt, Mg
importance.mic[,5] <- varImp(step.PC1F)$importance %>%rename(PC1F=Overall)

# PC2F
step.PC2F <- train(PC2F ~., data = soilmic2[,c(10,14:27)],
                    method = "leapSeq", #stepwise
                    tuneGrid = data.frame(nvmax = 1:13),
                    trControl = train.control)

plot(varImp(step.PC2F)) # pH, C, N
importance.mic[,6] <- varImp(step.PC2F)$importance %>%rename(PC2F=Overall)

# RichnessF
step.RichnessF <- train(RichnessF ~., data = soilmic2[,c(13,14:27)],
                    method = "leapSeq", #stepwise
                    tuneGrid = data.frame(nvmax = 1:13),
                    trControl = train.control)

plot(varImp(step.RichnessF)) # P, N, pH
importance.mic[,7] <- varImp(step.RichnessF)$importance %>%rename(RichnessF=Overall)

# ShannonF
step.ShannonF <- train(ShannonF ~., data = soilmic2[,c(11,14:27)],
                    method = "leapSeq", #stepwise
                    tuneGrid = data.frame(nvmax = 1:13),
                    trControl = train.control)

plot(varImp(step.ShannonF)) # N, NH4, silt
importance.mic[,8] <- varImp(step.ShannonF)$importance %>%rename(ShannonF=Overall)

# Pielou is composed of the other two indices so not including

mat <- t(importance.mic)
library(gplots)
tiff(filename='Fig5.tiff', width=180, height=180,units="mm",res=300)
fig6b<-heatmap.2(x=mat,
          dendrogram="none",
          Rowv = NULL,
          Colv=NULL,
          cexRow=1,cexCol=1,
          margins=c(9,9),
          trace="none",key=TRUE,keysize=1.5)
graphics.off()


```

Stepwise regression: does inclusion of microbial parameters alter the models for yield?
```{r}
soilmic3 <- soilmic2[complete.cases(soilmic2$Dry_beans_kg),]%>%select(-PielouB,-PielouF,-Sand,-P_CitAcExt) # remove collinear variables
# missing yield data means we have only have 39 samples to work with here

step.dry2 <- train(Dry_beans_kg ~., data = soilmic3[,c(3,4:24)],
                    method = "leapSeq", #stepwise
                    tuneGrid = data.frame(nvmax = 1:15),
                    trControl = train.control)
summary(step.dry2$finalModel) # 
importance.yield <- varImp(step.dry2)$importance %>%rename(Dry_beans_kg=Overall)


step.healthy2 <- train(Harvested_healthy ~., data = soilmic3[,c(1,4:24)],
                    method = "leapSeq", #stepwise
                    tuneGrid = data.frame(nvmax = 1:15),
                    trControl = train.control)
summary(step.healthy2$finalModel) # 
importance.yield[,2] <- varImp(step.healthy2)$importance %>%rename(Healthy_Pods=Overall)

step.infected2 <- train(Harvested_infected ~., data = soilmic3[,c(2,4:24)],
                    method = "leapSeq", #stepwise
                    tuneGrid = data.frame(nvmax = 1:15),
                    trControl = train.control)
summary(step.infected2$finalModel) # 
importance.yield[,3] <- varImp(step.infected2)$importance %>%rename(Infected_Pods=Overall)

importance.yield <- importance.yield %>% rename("Dry beans"="Dry_beans_kg","Healthy pods"="Healthy_Pods","Infected pods"="Infected_Pods")
mat <- t(importance.yield)
tiff(filename='plot_yield_heatmap.tiff', width=200, height=100,units="mm",res=300)
heatmap.2(x=mat,
          dendrogram="none",
          Rowv = NULL,
          Colv=NULL,
          cexRow=1,cexCol=1,
          margins=c(6,6),
          trace="none",key=TRUE,keysize=2)
dev.off()
```

Correlations of microbial properties and yield
```{r}
cor.test(soilmic2$ShannonF,soilmic2$Harvested_healthy,method="kendall",use="complete.obs") # tau 0.26, p=0.020

cor.test(soilmic2$Dry_beans_kg, soilmic2$ShannonF,method="kendall",use="complete.obs") # tau 0.28, p=0.012

cor.test(soilmic2$Harvested_infected, soilmic2$ShannonB,method="kendall",use="complete.obs") # tau 0.065,p=0.568

cor.test(soilmic2$Harvested_infected, soilmic2$PC1B,method="kendall") # tau 0.032, p=0.78

cor.test(soilmic2$Harvested_infected,soilmic2$PC2B,method="kendall")
# tau -0.043, p= 0.7

cor.test(soilmic2$Harvested_healthy, soilmic2$PC2F,method="kendall")
cor.test(soilmic2$Harvested_infected,soilmic2$PC2F,method="kendall")
# both p NS, tau 0.098,0.026
```

# Which fungi are in PC2F?
```{r}
psITS_filt <- filter_taxa(psITS, function(x) sum(x > 1) > 3, TRUE)
#PCA using vegan::rda
# Usually RDA is for constrained ordination (with covariates or predictor) but without those it's just PCA
(micrda <- rda(otu_table(psITS_filt),scale=FALSE)) # scaling means species will have unit variance, which is not how the data really is
# visualize
biplot(micrda,
       display = c("sites",  "species"),
       type = c("text","points"))
# which fungi contribute most to PC2?

pc2f_top <- data.frame(scores(micrda, choices = 2, display = "species", scaling = 0))%>% slice_max(order_by=PC2,n=100) %>% rownames_to_column("ASV") 

pc2f <- subset_taxa(psITS_filt,taxa_names(psITS_filt) %in% pc2f_top$ASV) 

head(tax_table(pc2f))
library(metacoder)
obj <- parse_phyloseq(pc2f,class_key="taxon_name")
print(obj)
set.seed(1)
tiff('test.tiff', units="in", width=5, height=4, res=300, compression = 'lzw')
obj_heat <- heat_tree(obj, 
          node_label = taxon_names,
          node_size = n_obs,
          node_size_axis_label = "OTU count",
          layout = "davidson-harel", # The primary layout algorithm
          initial_layout = "reingold-tilford") # The layout algorithm that initializes node locations
dev.off()

#saveRDS(pc2f,"PC2F.rds")
```

# Fungal functional predictions for PC2F
```{r}
# use microeco package with existing phyloseq objects
library(microeco)
# create microtable object
dataset2 <- microtable$new(sample_table = sample_data(pc2f), otu_table = as.matrix(t(otu_table(pc2f))), tax_table = as.data.frame(tax_table(pc2f)))
dataset2$tidy_dataset() # have to transpose asv table or get error

# create trans_func object
t2 <- trans_func$new(dataset2)
# identify species traits, automatically select database for prokaryotes or fungi
# fungi_database = "FungalTraits" for the FungalTraits database
t2$cal_spe_func(fungi_database = "FUNGuild")
pc2f_funguild <- t2$res_spe_func_raw_funguild

pc2f_funguild %>% filter(confidenceRanking=="Probable") %>% group_by(trophicMode)%>%tally()

t2$cal_spe_func(fungi_database="FungalTraits")
pc2f_fungaltraits <- t2$res_spe_func_raw_FungalTraits

pc2f_fungaltraits %>%  group_by(primary_lifestyle)%>%tally()
# fungal traits appears to be more helpful here
```


