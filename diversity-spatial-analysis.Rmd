---
title: "Diversification trial analysis"
author: "Jennifer Schmidt"
date: "3/5/2021"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE,warning=F,message=F}
library(geodist)
library(phyloseq)
library(tidyverse)
library(vegan)
library(ggplot2)
ps16S <- readRDS("tarengge16S.rds")
psITS <- readRDS("tarenggeITS.rds")
shade <- read.csv("data/shade_trees.csv")

#add shade trees to sample data
sample_data(ps16S)<-left_join(data.frame(sample_data(ps16S)),shade,by="ID")%>%column_to_rownames("Local.Label.x")
sample_data(psITS)<-left_join(data.frame(sample_data(psITS)),shade,by="ID")%>%column_to_rownames("Local.Label.x")

controls <- str_subset(sample_data(ps16S)$Local.Label.y,"Control")
sample_data(ps16S)$Group<- ifelse(sample_data(ps16S)$Local.Label.y %in% controls,"Control","Diversification")
sample_data(psITS)$Group<- ifelse(sample_data(psITS)$Local.Label.y %in% controls,"Control","Diversification")

ps16S_samples <- subset_samples(ps16S,Group=="Diversification")
psITS_samples <- subset_samples(psITS,Group=="Diversification")
```

## Calculate distance matrix for distance between sampling locations
Distance is in meters - see geodist vignettes.
```{r }
site_coordsB <- sample_data(ps16S) %>% data.frame() %>% select(Longitude,Latitude) 
distgeoB <- geodist(site_coordsB,measure="geodesic") # geodesic distance
max(distgeoB,na.rm=T) # max distance ~3146m if controls from adjacent plot are included
#hist(distgeoB)

distgeoB_samples <- geodist(site_coordsB[21:88,],measure="geodesic")
#hist(distgeoB_samples)
max(distgeoB_samples,na.rm=T) # only 241.5m within samples

# Fungi
site_coordsF <- sample_data(psITS) %>% data.frame() %>% rownames_to_column("rownames") %>% select(rownames,Longitude,Latitude) %>%arrange(rownames)%>%column_to_rownames("rownames") # need to arrange by sample name to have controls at the top
distgeoF <- geodist(site_coordsF,measure="geodesic") # geodesic distance
max(distgeoF,na.rm=T) # checking that it's the same
distgeoF_samples <- geodist(site_coordsF[21:99,],measure="geodesic")
hist(distgeoF_samples)
max(distgeoF_samples,na.rm=T) # only 241.5m within samples
```

## Bray-Curtis dissimilarity matrices
```{r}
distbrayB=vegdist(otu_table(ps16S), distance="bray")
distbrayF=vegdist(otu_table(psITS), distance="bray")

distbrayB_samples=vegdist(otu_table(ps16S_samples), distance="bray")
distbrayF_samples=vegdist(otu_table(psITS_samples), distance="bray")
```


## Bray-Curtis dissimilarity vs. distance
To assess distance-decay relationship (i.e. does dissimilarity between microbial communities increase with increasing geographic distance), we want to plot Bray-Curtis distance vs. geographic distance and fit a trendline.

```{r,echo=FALSE}
#Bacteria
data.frame(Bray=as.vector(distbrayB[upper.tri(distbrayB)]),
          Geo=as.vector(distgeoB[upper.tri(distgeoB)])) %>%ggplot(aes(x=Geo,y=Bray))+geom_point()+geom_smooth(data=subset(dat,Geo<1000),method="lm")+geom_smooth(data=subset(dat, Geo>1000), method = "lm")+theme_minimal()+theme(panel.grid.major.x=element_blank())

#Fungi
data.frame(Bray=as.vector(distbrayF[upper.tri(distbrayF)]),
          Geo=as.vector(distgeoF[upper.tri(distgeoF)])) %>%ggplot(aes(x=Geo,y=Bray))+geom_point()+geom_smooth(data=subset(dat,Geo<1000),method="lm")+geom_smooth(data=subset(dat, Geo>1000), method = "lm")+theme_minimal()+theme(panel.grid.major.x=element_blank())


# Look only at samples - bacteria
distB <- data.frame(Bray=as.vector(distbrayB_samples[upper.tri(distbrayB_samples)]), Geo=as.vector(distgeoB_samples[upper.tri(distgeoB_samples)])) 
distB %>% ggplot(aes(x=Geo,y=Bray))+geom_point()+geom_smooth(method="lm")+theme_minimal()+theme(panel.grid=element_blank())+labs(x="Geographic distance (m)",y="Bray-Curtis distance",title="Bacteria")+theme(plot.title=element_text(hjust=0.5))

#Fungi
distF <- data.frame(Bray=as.vector(distbrayF_samples[upper.tri(distbrayF_samples)]), Geo=as.vector(distgeoF_samples[upper.tri(distgeoF_samples)])) 
distF %>% ggplot(aes(x=Geo,y=Bray))+geom_point()+geom_smooth(method="lm")+theme_minimal()+theme(panel.grid=element_blank())+labs(x="Geographic distance (m)",y="Bray-Curtis distance",title="Fungi")+theme(plot.title=element_text(hjust=0.5))
```

# Correlations
```{r}
cor(distB$Bray,distB$Geo,use="complete.obs") # -0.033
cor(distF$Bray,distF$Geo,use="complete.obs") # -0.077
```

# Regression equation
```{r}
modB <- lm(Bray ~ Geo, data = distB)
summary(modB)# slope -7.216e-05, not significant

modF <- lm(Bray ~ Geo, data = distF)
summary(modF) # slope -1.606e-04, significant (p<0.05)*
```

# Mantel test
```{r}
mantel(distgeoB,distbrayB,permutations=999) # significant
```


# PCoA ordination of microbial communities
```{r}
# PCoA based on Bray-Curtis dissimilarity
ps16Slog <- transform_sample_counts(ps16S, function(x) log(1 + x))
out.pcoa.logB <- ordinate(ps16Slog,  method = "PCoA", distance = "bray")
evalsB <- out.pcoa.logB$values[,1]

(comp16S <- plot_ordination(ps16Slog, out.pcoa.logB, color = "Group") +
  labs(col = "Trial")+ theme_bw()+
  coord_fixed(sqrt(evalsB[2] / evalsB[1]))+
  theme(text=element_text(size=14),axis.title=element_text(size=14),legend.title=element_text(size=14),plot.title=element_text(hjust=0.5))+
  scale_color_brewer(palette="Set2")+
  theme(panel.grid=element_blank())+theme(legend.position="bottom")+theme(plot.margin=margin(1,1,1,1))+ggtitle("Bacteria"))

# Fungi
psITSlog <- transform_sample_counts(psITS, function(x) log(1 + x))
out.pcoa.logF <- ordinate(psITSlog,  method = "PCoA", distance = "bray")
evalsF <- out.pcoa.logF$values[,1]

(compITS <- plot_ordination(psITSlog, out.pcoa.logF, color = "Group") +
  labs(col = "Trial")+ theme_bw()+
  coord_fixed(sqrt(evalsF[2] / evalsF[1]))+
  theme(text=element_text(size=14),axis.title=element_text(size=14),legend.title=element_text(size=14),plot.title=element_text(hjust=0.5))+
  scale_color_brewer(palette="Set2")+
  theme(panel.grid=element_blank())+theme(legend.position="bottom")+theme(plot.margin=margin(1,1,1,1))+ggtitle("Fungi"))
```

# Effect of shade trees
```{r}
ps16Slog_samples <- transform_sample_counts(ps16S_samples, function(x) log(1 + x))
out.pcoa.logB_samples <- ordinate(ps16Slog_samples,  method = "PCoA", distance = "bray")
evalsB_samples <- out.pcoa.logB_samples$values[,1]
(shade16S <- plot_ordination(ps16Slog_samples, out.pcoa.logB_samples, color = "Shade_species") +
  labs(col = "Nearest Shade Species")+ theme_bw()+
  coord_fixed(sqrt(evalsB_samples[2] / evalsB_samples[1]))+
  theme(text=element_text(size=14),axis.title=element_text(size=14),legend.title=element_text(size=14))+
  scale_color_brewer(palette="BrBG")+
  theme(panel.grid=element_blank())+theme(plot.margin=margin(1,1,1,1)))

```




