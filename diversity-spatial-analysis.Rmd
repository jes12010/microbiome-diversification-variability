---
title: "Diversification trial analysis"
author: "Jennifer Schmidt"
date: "3/5/2021"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE,warning=F,message=F}
library(geodist)
library(phyloseq)
library(tidyverse)
library(vegan)
library(ggplot2)
library(ggpubr)
library(factoextra)
library(microbiome)
ps16S <- readRDS("tarengge16S.rds")
psITS <- readRDS("tarenggeITS.rds")
shade <- read.csv("data/shade_trees.csv")
soil <- read.csv("data/Soil_results_diversification.csv")

controls <- str_subset(sample_data(ps16S)$Local.Label.y,"Control")

sample_data(ps16S)$Group <- ifelse((sample_data(ps16S)$Shade_species=="None"&sample_data(ps16S)$Group=="Diversification"),"Diversification Control", paste(sample_data(ps16S)$Group)) # recode so we can separate out soil properties by shade tree presence
sample_data(ps16S)$Group <- factor(sample_data(ps16S)$Group,levels=c("Diversification","Monoculture","Diversification Control"))

sample_data(psITS)$Group <- ifelse((sample_data(psITS)$Shade_species=="None"&sample_data(psITS)$Group=="Diversification"),"Diversification Control", paste(sample_data(psITS)$Group)) # recode so we can separate out soil properties by shade tree presence
sample_data(psITS)$Group <- factor(sample_data(psITS)$Group,levels=c("Diversification","Monoculture","Diversification Control"))
sample_data(psITS)

# Divide samples into categories for visualization
ps16S_samples <- subset_samples(ps16S,Group=="Diversification")
ps16S_divcontrols <- subset_samples(ps16S,Group=="Diversification Control")
ps16S_controls <- subset_samples(ps16S,Group=="Monoculture")

psITS_samples <- subset_samples(psITS,Group=="Diversification")
psITS_divcontrols <- subset_samples(psITS,Group=="Diversification Control")
psITS_controls <- subset_samples(psITS,Group=="Monoculture")
```

## Calculate distance matrix for distance between sampling locations
Distance is in meters - see geodist vignettes.
```{r }
site_coordsB <- sample_data(ps16S) %>% data.frame() %>% select(Longitude,Latitude,Group) 
distgeoB <- geodist(site_coordsB[,c(1:2)],measure="geodesic") # geodesic distance
max(distgeoB,na.rm=T) # max distance ~115m 
hist(distgeoB)

distgeoB_samples <- subset(site_coordsB,Group=="Diversification") %>% geodist(measure="geodesic")
hist(distgeoB_samples)
max(distgeoB_samples,na.rm=T) # only 86m within samples
distgeoB_divcontrols <- subset(site_coordsB,Group=="Diversification Control") %>% geodist(measure="geodesic")
distgeoB_controls <- subset(site_coordsB,Group=="Monoculture") %>% geodist(measure="geodesic")

# distance to shade tree - only makes sense to include distances <5m if we assume litterfall, fine roots, etc. only impact the area directly around the tree
sample_data(ps16S)$Dist_shade <- geodist(data.frame(Longitude=sample_data(ps16S)$Longitude,Latitude=sample_data(ps16S)$Latitude),data.frame(Longitude=sample_data(ps16S)$Shade_Longitude,Latitude=sample_data(ps16S)$Shade_Latitude),paired=TRUE,measure="geodesic")

hist(sample_data(ps16S)$Dist_shade)


# Fungi
site_coordsF <- sample_data(psITS) %>% data.frame() %>% rownames_to_column("rownames") %>% select(rownames,Longitude,Latitude,Group) %>% column_to_rownames("rownames")  

distgeoF <- geodist(site_coordsF,measure="geodesic") # geodesic distance
max(distgeoF,na.rm=T) # checking that it's the same

distgeoF_samples <- subset(site_coordsF,Group=="Diversification") %>% geodist(measure="geodesic")
hist(distgeoF_samples)
max(distgeoF_samples,na.rm=T) # 83.5m within samples

distgeoF_divcontrols <- subset(site_coordsF,Group=="Diversification Control") %>% geodist(measure="geodesic")

distgeoF_controls <- subset(site_coordsF,Group=="Monoculture") %>% geodist(measure="geodesic")

sample_data(psITS)$Dist_shade <- geodist(data.frame(Longitude=sample_data(psITS)$Longitude,Latitude=sample_data(psITS)$Latitude),data.frame(Longitude=sample_data(psITS)$Shade_Longitude,Latitude=sample_data(psITS)$Shade_Latitude),paired=TRUE,measure="geodesic")
hist(sample_data(psITS)$Dist_shade)
```

## Bray-Curtis dissimilarity matrices
```{r}
distbrayB_samples=vegdist(data.frame(otu_table(ps16S_samples)), distance="bray")%>%as.matrix()
distbrayF_samples=vegdist(data.frame(otu_table(psITS_samples)), distance="bray")%>%as.matrix()

distbrayB_divcontrols=vegdist(data.frame(otu_table(ps16S_divcontrols)),distance="bray")%>%as.matrix()
distbrayF_divcontrols=vegdist(data.frame(otu_table(psITS_divcontrols)),distance="bray")%>%as.matrix()

distbrayB_controls=vegdist(data.frame(otu_table(ps16S_controls)), distance="bray")%>%as.matrix()
distbrayF_controls=vegdist(data.frame(otu_table(psITS_controls)), distance="bray")%>%as.matrix()
```


## Bray-Curtis dissimilarity vs. distance
To assess distance-decay relationships (i.e. does dissimilarity between microbial communities increase with increasing geographic distance), we want to plot Bray-Curtis distance vs. geographic distance and fit trendlines. Because we are interested in how the presence of shade trees affects these relationships, we plot the three sample groups separately and fit separate trendlines.

```{r,echo=FALSE}
distB_samples <- data.frame(Bray=as.vector(distbrayB_samples[upper.tri(distbrayB_samples)]), Geo=as.vector(distgeoB_samples[upper.tri(distgeoB_samples)]),Group="Diversification")

distB_divcontrols <- data.frame(Bray=as.vector(distbrayB_divcontrols[upper.tri(distbrayB_divcontrols)]), Geo=as.vector(distgeoB_divcontrols[upper.tri(distgeoB_divcontrols)]),Group="Diversification Control")

distB_controls <- data.frame(Bray=as.vector(distbrayB_controls[upper.tri(distbrayB_controls)]), Geo=as.vector(distgeoB_controls[upper.tri(distgeoB_controls)]),Group="Monoculture")
distB_all = rbind(distB_samples,distB_divcontrols,distB_controls)
distB_all$Group <- factor(distB_all$Group,levels=c("Diversification","Monoculture","Diversification Control"))

distB_all %>% ggplot(aes(x=Geo,y=Bray))+geom_point(aes(color=Group),alpha=0.2)+geom_smooth(aes(group=Group,color=Group),method="lm",alpha=0.2)+theme_minimal()+theme(panel.grid=element_blank())+labs(x="Geographic distance (m)",y="Bray-Curtis distance",title="Bacteria")+theme(plot.title=element_text(hjust=0.5))+scale_color_brewer(palette="Set2")+theme(legend.position="bottom")


distF_samples <- data.frame(Bray=as.vector(distbrayF_samples[upper.tri(distbrayF_samples)]), Geo=as.vector(distgeoF_samples[upper.tri(distgeoF_samples)]),Group="Diversification") 

distF_divcontrols <- data.frame(Bray=as.vector(distbrayF_divcontrols[upper.tri(distbrayF_divcontrols)]), Geo=as.vector(distgeoF_divcontrols[upper.tri(distgeoF_divcontrols)]),Group="Diversification Control") 

distF_controls <- data.frame(Bray=as.vector(distbrayF_controls[upper.tri(distbrayF_controls)]), Geo=as.vector(distgeoF_controls[upper.tri(distgeoF_controls)]),Group="Monoculture")

distF_all <- rbind(distF_samples,distF_divcontrols,distF_controls)
distF_all$Group <- factor(distF_all$Group,levels=c("Diversification","Monoculture","Diversification Control"))

distF_all %>% ggplot(aes(x=Geo,y=Bray))+geom_point(aes(color=Group),alpha=0.2)+geom_smooth(aes(group=Group,color=Group),method="lm",alpha=0.2)+theme_minimal()+theme(panel.grid=element_blank())+labs(x="Geographic distance (m)",y="Bray-Curtis distance",title="Fungi")+theme(plot.title=element_text(hjust=0.5))+scale_color_brewer(palette="Set2")+theme(legend.position="bottom")
```

# Correlations
```{r}
cor(distB_all$Bray,distB_all$Geo,use="complete.obs") # 0.412
cor(distF_all$Bray,distF_all$Geo,use="complete.obs") # 0.334
```

# Regression equation
```{r}
modB_samples <- lm(Bray ~ Geo, data = distB_samples)
summary(modB_samples)# slope 0.00249,int=0.6,both p<2e-16 ***
modB_divcontrols <- lm(Bray ~ Geo, data = distB_divcontrols)
summary(modB_divcontrols)# slope 0.00132,int=0.685,both p<0.001 ***
modB_controls <- lm(Bray ~ Geo, data = distB_controls)
summary(modB_controls)# slope NS, int 0.588

modF_samples <- lm(Bray ~ Geo, data = distF_samples)
summary(modF_samples) # slope 0.0017 int .640, p<0.001
modF_divcontrols <- lm(Bray ~ Geo, data = distF_divcontrols)
summary(modF_divcontrols) # slope 0.00157 int .676, p<0.001
modF_controls <- lm(Bray~Geo,data = distF_controls)
summary(modF_controls)
```

# Multiple matrix regression analysis (MMRR)
Wang et al. (2013) proposed this as an alternative to Mantel tests, which are increasingly thought of as less suitable for genetic/geographic analyses.
```{r}
# define functions as per Wang et al.
MMRR<-function(Y,X,nperm=999){
	#compute regression coefficients and test statistics
	nrowsY<-nrow(Y)
	y<-unfold(Y)
	if(is.null(names(X)))names(X)<-paste("X",1:length(X),sep="")
        Xmats<-sapply(X,unfold)
        fit<-lm(y~Xmats)
	coeffs<-fit$coefficients
	summ<-summary(fit)
	r.squared<-summ$r.squared
	tstat<-summ$coefficients[,"t value"]
	Fstat<-summ$fstatistic[1]
	tprob<-rep(1,length(tstat))
	Fprob<-1

	#perform permutations
	for(i in 1:nperm){
		rand<-sample(1:nrowsY)
		Yperm<-Y[rand,rand]
		yperm<-unfold(Yperm)
		fit<-lm(yperm~Xmats)
		summ<-summary(fit)
                Fprob<-Fprob+as.numeric(summ$fstatistic[1]>=Fstat)
                tprob<-tprob+as.numeric(abs(summ$coefficients[,"t value"])>=abs(tstat))
	}

	#return values
	tp<-tprob/(nperm+1)
	Fp<-Fprob/(nperm+1)
	names(r.squared)<-"r.squared"
	names(coeffs)<-c("Intercept",names(X))
	names(tstat)<-paste(c("Intercept",names(X)),"(t)",sep="")
	names(tp)<-paste(c("Intercept",names(X)),"(p)",sep="")
	names(Fstat)<-"F-statistic"
	names(Fp)<-"F p-value"
	return(list(r.squared=r.squared,
		coefficients=coeffs,
		tstatistic=tstat,
		tpvalue=tp,
		Fstatistic=Fstat,
		Fpvalue=Fp))
}

# unfold converts the lower diagonal elements of a matrix into a vector
# unfold is called by MMRR

unfold<-function(X){
	x<-vector()
	for(i in 2:nrow(X)) x<-c(x,X[i,1:i-1])
	x<-scale(x, center=TRUE, scale=TRUE)  # Comment this line out if you wish to perform the analysis without standardizing the distance matrices! 
	return(x)
}

# Bacteria
#Make a list of the explanatory (X) matrices
XmatsB <- list(geography=distgeoB_samples)#add soil data when received
distgeoB_samples <- as.matrix(distgeoB_samples)
# Run MMRR function using genetic distance as the response variable and Xmats as the explanatory variables.
# nperm does not need to be specified, default is nperm=999)
MMRR(distbrayB_samples,XmatsB,nperm=999) # p<0.001***, r2=0.254

#redefine for div controls
XmatsB <- list(geography=distgeoB_divcontrols)
MMRR(distbrayB_divcontrols,XmatsB,nperm=999) # p=0.003, r2=0.084

XmatsB <- list(geography=distgeoB_controls)
MMRR(distbrayB_controls,XmatsB,nperm=999) # p=0.537, r2=0.005

# Fungi
XmatsF <- list(geography=distgeoF_samples)
MMRR(distbrayF_samples,XmatsF,nperm=999) # r2=0.108,p=0.001

XmatsF <- list(geography=distgeoF_divcontrols)
MMRR(distbrayF_divcontrols,XmatsF,nperm=999) # r2=0.247,p<0.001

XmatsF <- list(geography=distgeoF_controls)
MMRR(distbrayF_controls,XmatsF,nperm=999) # NS (p=0.174),r2=0.029
```


# PCoA ordination of microbial communities
```{r}
# PCoA based on Bray-Curtis dissimilarity

ps16Slog <- transform_sample_counts(ps16S, function(x) log(1 + x))
out.pcoa.logB <- ordinate(ps16Slog,  method = "PCoA", distance = "bray")
evalsB <- out.pcoa.logB$values[,1]

(comp16S <- plot_ordination(ps16Slog, out.pcoa.logB, color = "Group") +
  labs(col = "Group")+ theme_bw()+
  coord_fixed(sqrt(evalsB[2] / evalsB[1]))+
  theme(text=element_text(size=14),axis.title=element_text(size=12),legend.title=element_blank(),plot.title=element_text(hjust=0.5,size=14))+
  scale_color_brewer(palette="Set2")+
  theme(panel.grid=element_blank())+theme(legend.position="bottom")+theme(plot.margin=margin(1,1,1,1))+ggtitle("Bacteria"))

# Fungi

psITSlog <- transform_sample_counts(psITS, function(x) log(1 + x))
out.pcoa.logF <- ordinate(psITSlog,  method = "PCoA", distance = "bray")
evalsF <- out.pcoa.logF$values[,1]

(compITS <- plot_ordination(psITSlog, out.pcoa.logF, color = "Group") +
  labs(col = "Group")+ theme_bw()+
  coord_fixed(sqrt(evalsF[2] / evalsF[1]))+
  theme(text=element_text(size=14),axis.title=element_text(size=12),legend.title=element_blank(),plot.title=element_text(hjust=0.5,size=14))+
  scale_color_brewer(palette="Set2")+
  theme(panel.grid=element_blank())+theme(legend.position="bottom")+theme(plot.margin=margin(1,1,1,1))+ggtitle("Fungi"))
```

# Effect of shade trees
```{r}
# shade trees are only listed for cacao trees that were immediately adjacent to a shade tree, otherwise listed as "none"
# these trees serve as a better control than the monoculture since they're within the same plot = same soil
# can't calculate distance to nearest shade tree because GPS is only accurate to ~3m and we don't know coordinates for all shade trees
head(sample_data(ps16S_samples))
ps16Sdiv <- subset_samples(ps16S,Group!="Monoculture")
ps16Slog_samples <- transform_sample_counts(ps16Sdiv, function(x) log(1 + x))
out.pcoa.logB_samples <- ordinate(ps16Slog_samples,  method = "PCoA", distance = "bray")
evalsB_samples <- out.pcoa.logB_samples$values[,1]
(shade16S <- plot_ordination(ps16Slog_samples, out.pcoa.logB_samples, color = "Shade_species") +
  labs(col = "Nearest Shade Species")+ theme_bw()+
  coord_fixed(sqrt(evalsB_samples[2] / evalsB_samples[1]))+
  theme(text=element_text(size=14),axis.title=element_text(size=14),legend.title=element_text(size=14))+
  scale_color_brewer(palette="BrBG")+
  theme(panel.grid=element_blank())+theme(plot.margin=margin(1,1,1,1))+ggtitle("Bacteria")+theme(legend.position = "bottom")+theme(plot.title = element_text(hjust=0.5))+guides(col=guide_legend(ncol=2)))

#ANOSIM is robust to unequal group sizes unlike PERMANOVA
anosim(data.frame(otu_table(ps16S_samples)), sample_data(ps16S_samples)$Shade_species, permutations = 999, distance = "jaccard", strata = NULL) # bray p = 0.537, jaccard 0.536
 
# Fungi
psITSdiv <- subset_samples(psITS,Group!="Monoculture")
psITSlog_samples <- transform_sample_counts(psITSdiv, function(x) log(1 + x))
out.pcoa.logF_samples <- ordinate(psITSlog_samples,  method = "PCoA", distance = "bray")
evalsF_samples <- out.pcoa.logF_samples$values[,1]
(shadeITS <- plot_ordination(psITSlog_samples, out.pcoa.logF_samples, color = "Shade_species") +
  labs(col = "Nearest Shade Species")+ theme_bw()+
  coord_fixed(sqrt(evalsF_samples[2] / evalsF_samples[1]))+
  theme(text=element_text(size=14),axis.title=element_text(size=14),legend.title=element_text(size=14))+
  scale_color_brewer(palette="BrBG")+
  theme(panel.grid=element_blank())+theme(plot.margin=margin(1,1,1,1))+ggtitle("Fungi")+theme(legend.position = "bottom")+theme(plot.title = element_text(hjust=0.5),legend.title=element_blank())+guides(col=guide_legend(ncol=3)))

#ANOSIM 
anosim(data.frame(otu_table(psITS_samples)), sample_data(psITS_samples)$Shade_species, permutations = 999, distance = "bray", strata = NULL) # NS for both
```


# Comparison of alpha diversity
```{r}
library(microbiomeutilities)
#richness
sample_data(psITS)$RichnessF <- specnumber(otu_table(psITS),MARGIN=1) # 1=rows, 2=col; samples are rows
# shannon index
sample_data(psITS)$ShannonF <- vegan::diversity(otu_table(psITS), "shannon")
sample_data(psITS)$PielouF <- (sample_data(psITS)$ShannonF/log(sample_data(psITS)$RichnessF))


div <- data.frame(sample_data(psITS)) %>% select("ID","Group","RichnessF","ShannonF","PielouF") %>%
  rename("Shannon Index" = "ShannonF","Pielou Index" = "PielouF") %>% pivot_longer(cols=c("Richness","Shannon Index","Pielou Index"),names_to="div")


(divITS <- ggplot(div,aes(x=Group,y=value))+
  geom_point(aes(col=Group))+theme_bw()+
  facet_wrap(~div,scales="free")+
  scale_color_brewer(palette="Set2")+
  theme(panel.grid=element_blank())+
  theme(text=element_text(size=14))+stat_compare_means(comparisons=list(c("Monoculture","Diversification"),c("Diversification","Diversification Control")),label="p.signif")+
  theme(axis.text.x=element_blank(),axis.title.x=element_blank(),axis.ticks.x=element_blank())+
  theme(axis.title.y=element_blank())+theme(legend.position="bottom"))


# Bacteria
#richness
sample_data(ps16S)$RichnessB <- specnumber(otu_table(ps16S),MARGIN=1)
# shannon index
sample_data(ps16S)$ShannonB <- vegan::diversity(otu_table(ps16S), "shannon")
sample_data(ps16S)$PielouB <- (sample_data(ps16S)$ShannonB/log(sample_data(ps16S)$RichnessB))


div <- data.frame(sample_data(ps16S)) %>% select("ID","Group","RichnessB","ShannonB","PielouB") %>%
  rename("Shannon Index" = "ShannonB","Pielou Index" = "PielouB") %>% pivot_longer(cols=c("Richness","Shannon Index","Pielou Index"),names_to="div")

(div16S <- ggplot(div,aes(x=Group,y=value))+
  geom_point(aes(col=Group))+theme_bw()+
  facet_wrap(~div,scales="free")+
  scale_color_brewer(palette="Set2")+
  theme(panel.grid=element_blank())+
  theme(text=element_text(size=14))+
  theme(axis.text.x=element_blank(),axis.title.x=element_blank(),axis.ticks.x=element_blank())+stat_compare_means(comparisons=list(c("Monoculture","Diversification"),c("Diversification","Diversification Control")),label="p.signif")+theme(axis.title.y=element_blank())+theme(legend.position="bottom"))
```

# Overall compositions: Diversification vs. Monoculture Plots
```{r}
library(microViz)
(comp16S <- ps16S %>%phyloseq::merge_samples(group = "Group")%>% tax_fix %>%
  comp_barplot(
    tax_level = "Phylum", n_taxa = 12,
    bar_outline_colour = "grey5",
    merge_other = FALSE,
    sample_order = "bray", 
    tax_order = sum,
      bar_width = 0.7) + coord_flip() +
    theme(legend.position="bottom")+theme(axis.text=element_text(size=10),axis.title=element_text(size=10),strip.text=element_text(size=10),legend.text=element_text(size=10))+ guides(fill=guide_legend(ncol=3))+ theme(legend.title = element_blank())+theme(plot.margin = margin(0, 0.6, 0, 0.5, "cm")))

(compITS <- psITS %>%phyloseq::merge_samples(group = "Group")%>% tax_fix %>%
  comp_barplot(
    tax_level = "Phylum", n_taxa = 12,
    bar_outline_colour = "grey5",
    merge_other = FALSE,
    sample_order = "bray", 
    tax_order = sum,
      bar_width = 0.7) + coord_flip() +
    theme(legend.position="bottom")+theme(axis.text=element_text(size=10),axis.title=element_text(size=10),strip.text=element_text(size=10),legend.text=element_text(size=10))+ guides(fill=guide_legend(ncol=3))+ theme(legend.title = element_blank())+theme(plot.margin = margin(0, 0.5, 0, 0.5, "cm")))
```

# Soil physicochemical parameters
We know from the ANOSIM analysis that within a plot, presence of shade trees doesn't have a direct effect. However, given the differences between plots, we want to ask which soil properties might be most influential on soil microbial community composition.

First, visualize differences among plots.

# PCA
```{r}
head(soil)
soil <- soil %>% select(-Rownames,-Group)
datF <- data.frame(sample_data(psITS))
fullsoil <- left_join(datF[,c(7,10:25)],soil,by="Local.Label.y")%>% filter(complete.cases(.$Sand))%>%column_to_rownames("Local.Label.y") %>% select(-P_Olsen)
# control plot didn't have P_Olsen measured so need to remove that to keep diversification and monoculture in PCA


library(factoextra)

fullsoil2 <- fullsoil[complete.cases(fullsoil[,16:37]),]
groups <- as.factor(fullsoil2$Group)
nut.pca <- prcomp(fullsoil2[,16:37],scale=TRUE)
fviz_eig(nut.pca) # scree plot

options(ggrepel.max.overlaps = Inf) 
(pcaplot <- fviz_pca_biplot(nut.pca, geom_ind="point",
                            label="var",
                            repel = TRUE,
                col.var = "#696969", # Variables color
                col.ind = groups, # color by groups
             palette = "Set2",# Individuals color
             title=NULL,
             ggtheme=theme_minimal())+ labs(col="Group",shape="Group")+scale_shape_manual(values=c(rep(19,8))))
```


# Properties that differ between plots
```{r}
library(ggpubr)
# separate out only soil properties
soilplot <- fullsoil[,c(4,19:40)]  
soilplot <- subset(soilplot,soilplot$P_CitAcExt<500) # outlier

# check correlations
res <- as.matrix(cor(soilplot[,2:23], method = "kendall", use = "complete.obs"))
library(corrplot)
corrplot(res,type="upper")

# need to remove highly correlated variables for model selection and plotting
soilplot <- soilplot %>%
  select(-CaO,-MgO,-K2O,-P2O5,-pH_KCl,-Total_Cations,-C_N) %>%
  rename("Base saturation"="Base_sat", 
         "% C" = "C_percent","% N" = "N_percent", 
         "NO3-N"="NO3_N_mg","NH4-N"="NH4_N_mg", "P"="P_CitAcExt",
         "pH"="pH_H2O",
         "Silt"="Loam") %>% 
  pivot_longer(cols=2:16,names_to="Parameter")
#unique(soilplot$Parameter)
soilplot$Parameter <- factor(soilplot$Parameter,levels=c("Sand","Silt","Clay","% C","% N","CEC","Base saturation","pH","Na","NO3-N","NH4-N","P","K","Ca","Mg"))

soilplot$Group <- factor(soilplot$Group,levels=c("Diversification","Monoculture","Diversification Control"))


soilplot%>% 
  #filter(Group!="Monoculture") %>%
  ggplot(aes(x=Group,y=value))+
  geom_point(aes(col=Group))+theme_bw()+
  facet_wrap(~Parameter,scales="free",ncol=3)+
  scale_color_brewer(palette="Set2")+
  theme(panel.grid=element_blank())+
  theme(text=element_text(size=14))+
  theme(axis.text.x=element_blank(),axis.title.x=element_blank(),axis.ticks.x=element_blank())+
  theme(axis.title.y=element_blank())+
  stat_compare_means(comparisons=list(c("Monoculture","Diversification"),c("Diversification","Diversification Control")),label="p.signif",vjust=0.5)+theme(legend.position="bottom")
```


# Properties that differ by presence/absence of shade trees
The above plots show that NH4-N, P, and pH differ by shade tree presence rather than plot. Are there effects of shade tree species?
```{r}
hist(log(fullsoil$NH4_N_mg)) # need to log-transform for normality
NH4_mod <- lm(log(NH4_N_mg)~Shade_species,fullsoil)
hist(resid(NH4_mod))
summary(aov(NH4_mod)) # p=0.45 NS

hist(log(fullsoil$P_CitAcExt))
P_mod <- lm(log(P_CitAcExt)~Shade_species,fullsoil)
summary(aov(P_mod)) # p = 0.51 NS

hist(fullsoil$pH_H2O)
hist(sqrt(8-fullsoil$pH_H2O)) # closest to normality of sqrt, cube root, log of constant - x
pH_mod <- lm(sqrt(8-pH_H2O)~Shade_species,fullsoil)
hist(resid(pH_mod))
summary(aov(pH_mod)) # p<0.01**

TukeyHSD(aov(pH_mod)) # banana, red teak, and sengon are significantly different from none, but not from one another

```



# Yield
```{r}
fullsoil %>% subset(.,complete.cases(fullsoil$Shade_species)) %>% ggplot(aes(x=Shade_species,y=Dry_beans_kg))+geom_point(aes(col=Shade_species))+stat_compare_means(hjust=0.1)+theme_bw()+theme(panel.grid=element_blank())+scale_color_brewer(palette="BrBG")+labs(x="Shade species",y="Yield (kg dry beans)")+theme(legend.position = "none")+theme(axis.text.x=element_text(angle=45,hjust=1))

fullsoil %>% subset(.,complete.cases(fullsoil$Shade_species)) %>% ggplot(aes(x=Shade_species,y=Harvested_healthy))+geom_point(aes(col=Shade_species))+stat_compare_means(hjust=0.1)+theme_bw()+theme(panel.grid=element_blank())+scale_color_brewer(palette="BrBG")+labs(x="Shade species",y="Yield (healthy pods)")+theme(legend.position = "none")+theme(axis.text.x=element_text(angle=45,hjust=1))

fullsoil %>%subset(.,complete.cases(fullsoil$Shade_species)) %>% ggplot(aes(x=Shade_species,y=Harvested_infected))+geom_point(aes(col=Shade_species))+stat_compare_means(hjust=0.1)+theme_bw()+theme(panel.grid=element_blank())+scale_color_brewer(palette="BrBG")+labs(x="Shade species",y="Yield (infected pods)")+theme(legend.position="none")+theme(axis.text.x=element_text(angle=45,hjust=1))
```

# Do any soil properties predict yield?
```{r}
# only works when response variable is present
# again, remove highly correlated variables
soilyield <- fullsoil[complete.cases(fullsoil$Dry_beans_kg),c(1:3,16:37)] %>% select(-CaO,-MgO,-K2O,-P2O5,-pH_KCl,-Total_Cations,-C_N)

# first, check variables for outliers - normality is not a requirement for regression, but may need to transform very skewed variables or deal with outliers
colnames(soilyield)
library(tidyverse)
soilyield %>%
  gather() %>% 
  ggplot(aes(value)) +
    facet_wrap(~ key, scales = "free") +
    geom_histogram()
# none of the values seem crazy, perhaps with exception of a single high P value, but a few variables would be better transformed

hist(log(soilyield$NH4_N_mg))
soilyield$C <- exp(soilyield$C_percent)
soilyield$P <- log(soilyield$P_CitAcExt)
soilyield$CEC_log <- log(soilyield$CEC)
soilyield$K_log <- log(soilyield$K)
soilyield$NH4 <- log(soilyield$NH4_N_mg)

soilyield2 <- soilyield %>% select(-NH4_N_mg,-C_percent,-P_CitAcExt,-CEC,-K)

library(caret)
# Set seed for reproducibility
set.seed(123)
# Set up repeated k-fold cross-validation
train.control <- trainControl(method = "cv", number = 10)



# Dry beans
step.drybeans <- train(Dry_beans_kg ~., data = soilyield2[,c(3,4:18)],
                    method = "leapSeq", #stepwise
                    tuneGrid = data.frame(nvmax = 1:14),
                    trControl = train.control
                    )
 
#summary(step.drybeans$finalModel) finalModel changes

plot(varImp(step.drybeans)) #  No3,Sand,Na,K
importance.dry <- varImp(step.drybeans)$importance %>%rename('Dry Beans'=Overall)
importance <- data.frame(importance.dry)

```

```{r}
step.healthy <- train(Harvested_healthy ~., data = soilyield2[,c(1,4:18)],
                    method = "leapSeq", #stepwise
                    tuneGrid = data.frame(nvmax = 1:14),
                    trControl = train.control
                    )
 
#summary(step.healthy$finalModel) 

plot(varImp(step.healthy)) # No3,P_CitAcExt,Sand,Na
importance.healthy <- varImp(step.healthy)$importance %>%rename(`Healthy Pods`=Overall)
importance[,2] <- importance.healthy
```

```{r}
step.infected <- train(Harvested_infected ~., data = soilyield2[,c(2,4:18)],
                    method = "leapSeq", #stepwise
                    tuneGrid = data.frame(nvmax = 1:14),
                    trControl = train.control
                    )
 
#summary(step.infected$finalModel) #P_CitAcExt

plot(varImp(step.infected)) #  Loam, Mg, P
importance.inf <- varImp(step.infected)$importance %>%rename('Infected Pods'=Overall)
importance[,3] <- importance.inf
```

# Heatmap
```{r}
colnames(importance)
importance <- importance %>% rename('Dry Beans'=Dry.Beans)
importance2 <- arrange(importance,rownames(importance))
mat <- t(importance2)
library(gplots)
tiff(filename='yield_varImp.tiff', width=180, height=100,units="mm",res=300)
heatmap.2(x=mat,
          dendrogram="none",
          Rowv = NULL,
          Colv=NULL,
          cexRow=1,cexCol=1,
          margins=c(9,9),
          trace="none",key=FALSE)
graphics.off()
```


# Are there any correlations between soil nutrients and yield?
Use Kendall correlation coefficient (rank-based non-parametric) instead of Pearson correlation coefficient (direct correlation, only good for normal distributions).
```{r}
# Healthy pods
cor(soilyield2[4:18], soilyield2[2],method="kendall",use="complete.obs")
# highest absolute values for dry beans: N_percent, Sand, Loam,K,Na, none significant
# infected pods: NH4N p=0.049
# healthy pods: N_percent, but not significant
cor.test(soilyield2$Harvested_infected,soilyield2$P,method="kendall",use="complete.obs")


# Correlation plots for significant parameters
library(grid)
library(gridExtra)
grob1 = grobTree(textGrob(paste("Kendall Correlation : ", round(cor(soilyield2$Harvested_infected, soilyield2$NH4,method="kendall"), 3),"p=0.049" ), x = 0.48, y = 0.97, hjust = 0, gp = gpar(col = "red", fontsize = 11, fontface = "bold")))

ggplot(soilyield, aes(x=NH4_N_mg, y=Harvested_infected)) + geom_point() + ggtitle("Infected pods vs. NH4-N") + geom_smooth(method=lm, se=FALSE) + scale_x_continuous(name = "NH4-N") + scale_y_continuous(name = "Infected pods") + theme(plot.title = element_text(hjust = 0.5), panel.background = element_blank(), axis.line = element_line(color="black"), axis.line.x = element_line(color="black"))

ggplot(soilyield, aes(x=NO3_N_mg, y=Dry_beans_kg)) + geom_point() + ggtitle("Dry beans vs. NO3-N") + geom_smooth(method=lm, se=FALSE) + scale_x_continuous(name = "NO3-N") + scale_y_continuous(name = "Dry beans (kg)") + theme(plot.title = element_text(hjust = 0.5), panel.background = element_blank(), axis.line = element_line(color="black"), axis.line.x = element_line(color="black"))

# relationship of soil P and infected pods - re-run with different correlations
hist(log(soilyield$P_CitAcExt)) # should log transform

library(ggplot2)
colnames(soilyield)
ggplot(soilyield2, aes(x=NH4, y=Harvested_infected)) + geom_point() + ggtitle("Infected pods vs. NH4-N") + geom_smooth(method=lm, se=FALSE) + scale_x_continuous(name = "NH4-N (log scale)") + scale_y_continuous(name = "Infected pods") + theme(plot.title = element_text(hjust = 0.5), panel.background = element_blank(), axis.line = element_line(color="black"), axis.line.x = element_line(color="black"))+annotation_custom(grob1)
```



# Principal components of microbial communities
```{r}
# Add bacterial and fungal PCs (first and second)
library(vegan)
library(phyloseq)
(bactrda <- rda(otu_table(ps16S)))
summary(eigenvals(bactrda)) 

sample_data(ps16S)$PC1B <- scores(bactrda)$sites[,1]
sample_data(ps16S)$PC2B <- scores(bactrda)$sites[,2]

funrda <- rda(otu_table(psITS))
sample_data(psITS)$PC1F <- scores(funrda)$sites[,1]
sample_data(psITS)$PC2F <- scores(funrda)$sites[,2]

PCBs <- data.frame(sample_data(ps16S))%>% select(Local.Label.y,PC1B,PC2B,ShannonB,PielouB,RichnessB)%>%rename("Rownames"="Local.Label.y")
PCFs <- data.frame(sample_data(psITS))%>%select(Local.Label.y,PC1F,PC2F,ShannonF,PielouF,RichnessF)%>%rename("Rownames"="Local.Label.y")
micPCs <- left_join(PCBs,PCFs)

fullsoil2 <- fullsoil %>% select(-Rownames,-Group.x,-Group.y,-PC1F,-PC2F,-ShannonF,-RichnessF,-PielouF) %>% rownames_to_column("Rownames")
soilmic <- merge(fullsoil2,micPCs,by="Rownames")%>%
  select(-CaO,-MgO,-K2O,-P2O5,-pH_KCl,-Total_Cations,-C_N,-Local.Label,-Longitude,-Latitude,-Nearest_shade,-Shade_species,-Shade_Longitude,-Shade_Latitude,-Base_sat) %>%
  rename( "NO3-N"="NO3_N_mg","NH4-N"="NH4_N_mg", 
         "pH"="pH_H2O",
         "Silt"="Loam")  %>% column_to_rownames("Rownames")
# crazy outlier for fungal communities
soilmic2 <- subset(soilmic,PC1F<140&PC2F<140)

soilmic2 %>%
  gather() %>% 
  ggplot(aes(value)) +
    facet_wrap(~ key, scales = "free") +
    geom_histogram()

# transform skewed variables

soilmic2$C <- exp(soilmic2$C_percent)
soilmic2$P <- log(soilmic2$P_CitAcExt)
soilmic2$K_log <- log(soilmic2$K)
soilmic2$NH4 <- log(soilmic2$'NH4-N')

soilmic2 <- soilmic2 %>% select(-K,-`NH4-N`,-C_percent,-P_CitAcExt)%>%select(Harvested_healthy,Harvested_infected,Dry_beans_kg,PC1B,PC2B,ShannonB,PielouB,RichnessB,PC1F,PC2F,ShannonF,PielouF,RichnessF,everything())
```


# What soil properties predict the microbiome?
```{r}
colnames(soilmic2)
library(caret)
step.PC1B <- train(PC1B ~., data = soilmic2[,c(4,14:27)],
                    method = "leapSeq", #stepwise
                    tuneGrid = data.frame(nvmax = 1:13),
                    trControl = train.control)

plot(varImp(step.PC1B)) # pH, Mg, %C,%N
importance.mic <- varImp(step.PC1B)$importance %>%rename(PC1B=Overall)


# PC2B
step.PC2B <- train(PC2B ~., data = soilmic2[,c(5,14:27)],
                    method = "leapSeq", #stepwise
                    tuneGrid = data.frame(nvmax = 1:13),
                    trControl = train.control)

plot(varImp(step.PC2B)) # K, Clay, P
importance.mic[,2] <- varImp(step.PC2B)$importance %>%rename(PC2B=Overall)


# RichnessB
step.RichnessB <- train(RichnessB ~., data = soilmic2[,c(8,14:27)],
                    method = "leapSeq", #stepwise
                    tuneGrid = data.frame(nvmax = 1:13),
                    trControl = train.control)

plot(varImp(step.RichnessB)) # Mg, K, Clay
importance.mic[,3] <- varImp(step.RichnessB)$importance %>%rename(RichnessB=Overall)



# ShannonB
step.ShannonB <- train(ShannonB ~., data = soilmic2[,c(6,14:27)],
                    method = "leapSeq", #stepwise
                    tuneGrid = data.frame(nvmax = 1:13),
                    trControl = train.control)

plot(varImp(step.ShannonB)) # Clay, Mg, Ca
importance.mic[,4] <- varImp(step.ShannonB)$importance %>%rename(ShannonB=Overall)

# PC1F
step.PC1F <- train(PC1F ~., data = soilmic2[,c(9,14:27)],
                    method = "leapSeq", #stepwise
                    tuneGrid = data.frame(nvmax = 1:13),
                    trControl = train.control)
 
summary(step.PC1F$finalModel) #Na

plot(varImp(step.PC1F)) #  Na, Silt, Mg
importance.mic[,5] <- varImp(step.PC1F)$importance %>%rename(PC1F=Overall)

# PC2F
step.PC2F <- train(PC2F ~., data = soilmic2[,c(10,14:27)],
                    method = "leapSeq", #stepwise
                    tuneGrid = data.frame(nvmax = 1:13),
                    trControl = train.control)

plot(varImp(step.PC2F)) # pH, C, N
importance.mic[,6] <- varImp(step.PC2F)$importance %>%rename(PC2F=Overall)

# RichnessF
step.RichnessF <- train(RichnessF ~., data = soilmic2[,c(13,14:27)],
                    method = "leapSeq", #stepwise
                    tuneGrid = data.frame(nvmax = 1:13),
                    trControl = train.control)

plot(varImp(step.RichnessF)) # P, N, pH
importance.mic[,7] <- varImp(step.RichnessF)$importance %>%rename(RichnessF=Overall)

# ShannonF
step.ShannonF <- train(ShannonF ~., data = soilmic2[,c(11,14:27)],
                    method = "leapSeq", #stepwise
                    tuneGrid = data.frame(nvmax = 1:13),
                    trControl = train.control)

plot(varImp(step.ShannonF)) # N, NH4, silt
importance.mic[,8] <- varImp(step.ShannonF)$importance %>%rename(ShannonF=Overall)

# Pielou is composed of the other two indices so not including

mat <- t(importance.mic)
library(gplots)
tiff(filename='micVarImp.tiff', width=180, height=180,units="mm",res=300)
heatmap.2(x=mat,
          dendrogram="none",
          Rowv = NULL,
          Colv=NULL,
          cexRow=1,cexCol=1,
          margins=c(9,9),
          trace="none",key=FALSE)
graphics.off()
```

# What microbial properties might predict yield?
First, check whether addition of PCs alters the models for yield.
```{r}
colnames(soilmic3)
soilmic3 <- soilmic2[complete.cases(soilmic$Dry_beans_kg),]
# check PCs - note that missing data means we have only have 37 samples to work with here
soilmic3 <- subset(soilmic3, !is.na(Dry_beans_kg))
step.dry2 <- train(Dry_beans_kg ~., data = soilmic3[,c(7,1:4,8:24)],
                    method = "leapSeq", #stepwise
                    tuneGrid = data.frame(nvmax = 1:15),
                    trControl = train.control)
summary(step.dry2$finalModel) # 
importance.yield <- varImp(step.dry2)$importance %>%rename(Dry_beans_kg=Overall)


step.healthy2 <- train(Harvested_healthy ~., data = soilmic3[,c(5,1:4,8:24)],
                    method = "leapSeq", #stepwise
                    tuneGrid = data.frame(nvmax = 1:15),
                    trControl = train.control)
summary(step.healthy2$finalModel) # Pielou and nitrate
importance.yield[,2] <- varImp(step.healthy2)$importance %>%rename(Healthy_Pods=Overall)

step.infected2 <- train(Harvested_infected ~., data = soilmic3[,c(6,1:4,8:24)],
                    method = "leapSeq", #stepwise
                    tuneGrid = data.frame(nvmax = 1:15),
                    trControl = train.control)
summary(step.infected2$finalModel) # P, NH4
importance.yield[,3] <- varImp(step.infected2)$importance %>%rename(Infected_Pods=Overall)

mat <- t(importance.yield)
heatmap.2(x=mat,
          dendrogram="none",
          Rowv = NULL,
          Colv=NULL,
          cexRow=1,cexCol=1,
          margins=c(9,9),
          trace="none",key=FALSE)
```

# Check correlations of microbial properties and yield
```{r}
cor(soilmic3[5], soilmic3[c(1:4,8:9)],method="kendall",use="complete.obs")
cor.test(soilmic3$Shannon,soilmic3$Harvested_healthy,method="kendall",use="complete.obs") # p= 0.0086 (others NS)

cor(soilmic3[6], soilmic3[c(1:4,8:9)],method="kendall",use="complete.obs")# all NS

cor(soilmic3[7], soilmic3[c(1:4,8:9)],method="kendall",use="complete.obs")
cor.test(soilmic3$Shannon,soilmic3$Dry_beans_kg,method="kendall",use="complete.obs") # p= 0.0049 (others NS)

# Correlation plots for significant parameters
library(grid)
library(gridExtra)
grob1 = grobTree(textGrob(paste("Kendall Correlation : ", round(cor(soilmic3$Harvested_healthy, soilmic3$Shannon,method="kendall"), 3),"p=0.0086" ), x = 0.48, y = 0.97, hjust = 0, gp = gpar(col = "red", fontsize = 11, fontface = "bold")))

ggplot(soilmic3, aes(x=Shannon, y=Harvested_healthy)) + geom_point() + ggtitle("Healthy pods vs. microbial diversity") + geom_smooth(method=lm, se=FALSE) + scale_x_continuous(name = "Shannon index") + scale_y_continuous(name = "Harvested pods") + theme(plot.title = element_text(hjust = 0.5), panel.background = element_blank(), axis.line = element_line(color="black"), axis.line.x = element_line(color="black"))+annotation_custom(grob1)
```

# Which fungi are in PC2F?
```{r}
psITS_filt <- filter_taxa(psITS, function(x) sum(x > 1) > 3, TRUE)
#PCA using vegan::rda
# Usually RDA is for constrained ordination (with covariates or predictor) but without those it's just PCA
(micrda <- rda(otu_table(psITS_filt),scale=FALSE)) # scaling means species will have unit variance, which is not how the data really is
# visualize
biplot(micrda,
       display = c("sites",  "species"),
       type = c("text","points"))
# which fungi contribute most to PC2?

pc2f_top <- data.frame(scores(micrda, choices = 2, display = "species", scaling = 0))%>% slice_max(order_by=PC2,n=100) %>% rownames_to_column("ASV") 

pc2f <- subset_taxa(psITS_filt,taxa_names(psITS_filt) %in% pc2f_top$ASV) 

head(tax_table(pc2f))
library(metacoder)
obj <- parse_phyloseq(pc2f,class_key="taxon_name")
print(obj)
set.seed(1)
tiff('test.tiff', units="in", width=5, height=4, res=300, compression = 'lzw')
obj_heat <- heat_tree(obj, 
          node_label = taxon_names,
          node_size = n_obs,
          node_size_axis_label = "OTU count",
          layout = "davidson-harel", # The primary layout algorithm
          initial_layout = "reingold-tilford") # The layout algorithm that initializes node locations
dev.off()

saveRDS(pc2f,"PC2F.rds")
```


# DESeq2 method with standardized residuals of beans as continuous predictor
```{r}
library(phyloseq)
library(DESeq2)

ps16S_filt <- subset_samples(ps16S,sample_data(ps16S)$Local.Label.y%in% rownames(soilmic)) # 49 samples with soil, microbial data

# Filter out taxa occurring in fewer than 3 samples
ps16S_filt <- filter_taxa(ps16S_filt, function(x) sum(x > 1) > 3, TRUE)

# Filter out samples without yield data
ps16S_filt <- subset_samples(ps16S_filt,!is.na(sample_data(ps16S_filt)$Dry_beans_kg)) # 39 samples, 955 taxa

# add soil data to sample data
soilmic$Local.Label.y=rownames(soilmic) # set up merge

#sample_data(ps16S_filt) 
sample_data(ps16S_filt) <- data.frame(sample_data(ps16S_filt)) %>% rownames_to_column("Sample_names")%>%left_join(soilmic,by="Local.Label.y") %>% data.frame() %>% column_to_rownames("Sample_names")

head(sample_data(ps16S_filt))

beans16S <- lm(Dry_beans_kg.y~NO3.N,data=data.frame(sample_data(ps16S_filt))) # residuals not explained by soil nitrogen
sample_data(ps16S_filt)$beans_res <- beans16S$residuals # residuals
sample_data(ps16S_filt)$beans_std_res <- rstandard(beans16S) # standardized residuals


#standardized residuals as continuous predictor
ps_dds = phyloseq_to_deseq2(ps16S_filt, ~ beans_std_res)

#determine best fit type 
DDS <- estimateSizeFactors(ps_dds)
par <- estimateDispersions(DDS, fitType = "parametric")
loc <- estimateDispersions(DDS, fitType = "local")
plotDispEsts(par, main= "dispEst: parametric")
plotDispEsts(loc, main= "dispEst: local")

diagdds = DESeq(ps_dds, test="Wald", fitType="local") 
#resultsNames(diagdds)
res = results(diagdds, name="beans_std_res", cooksCutoff = FALSE)
alpha = 0.05
sigtab = res[which(res$padj < alpha), ] # 0
sigtab = cbind(as(sigtab, "data.frame"), as(tax_table(ps16S_filt)[rownames(sigtab), ], "matrix"))

# need a figure showing relationship with yield
subset_beans <- subset_taxa(ps16S_filt, taxa_names(ps16S_filt)%in%rownames(sigtab))
dat_beans <- psmelt(subset_beans) # create data frame
(plot_beans<-ggplot(dat_beans, aes(x=Dry_beans_kg.y, y=Abundance, col=Phylum)) + geom_point(aes(col=Phylum))+facet_wrap(Family~OTU, scales="free",ncol=2)+theme_bw()+theme(panel.grid=element_blank())+theme(legend.position="bottom")+scale_color_brewer(palette="Set2")+labs(x="Dry beans (kg)"))
    
```

DESeq for fungi
```{r}
psITS_filt <- subset_samples(psITS,sample_data(psITS)$Local.Label%in% rownames(soilmic)) # 39 samples with soil, microbial data

# Filter out taxa occurring in fewer than 3 samples
psITS_filt <- filter_taxa(psITS_filt, function(x) sum(x > 1) > 3, TRUE)

# Filter out samples without yield data
psITS_filt <- subset_samples(psITS_filt,!is.na(sample_data(psITS_filt)$Dry_beans_kg)) # 39 samples

# add soil data to sample data
soilmic$Local.Label=rownames(soilmic) # set up merge

sample_data(psITS_filt) <- data.frame(sample_data(psITS_filt)) %>% rownames_to_column("Sample_names")%>%left_join(soilmic,by="Local.Label") %>% data.frame() %>% column_to_rownames("Sample_names")

head(sample_data(psITS_filt))

beansITS <- lm(Dry_beans_kg.y~NO3.N,data=data.frame(sample_data(psITS_filt)))
sample_data(psITS_filt)$beans_res <- beansITS$residuals # residuals
sample_data(psITS_filt)$beans_std_res <- rstandard(beansITS) # standardized residuals


#standardized residuals as continuous predictor
ps_dds = phyloseq_to_deseq2(psITS_filt, ~ beans_std_res)

#determine best fit type 
DDS <- estimateSizeFactors(ps_dds)
par <- estimateDispersions(DDS, fitType = "parametric")
loc <- estimateDispersions(DDS, fitType = "local")
plotDispEsts(par, main= "dispEst: parametric")
plotDispEsts(loc, main= "dispEst: local")

diagdds = DESeq(ps_dds, test="Wald", fitType="local") 
#resultsNames(diagdds)
res = results(diagdds, name="beans_std_res", cooksCutoff = FALSE)
alpha = 0.05
sigtab = res[which(res$padj < alpha), ] # 
sigtab = cbind(as(sigtab, "data.frame"), as(tax_table(psITS_filt)[rownames(sigtab), ], "matrix")) #34

# need a figure showing relationship with yield
subset_beansITS <- subset_taxa(psITS_filt, taxa_names(psITS_filt)%in%rownames(sigtab))
dat_beansITS <- psmelt(subset_beansITS) # create data frame
(plot_beansITS<-ggplot(dat_beansITS, aes(x=Dry_beans_kg.y, y=Abundance, col=Phylum)) + geom_point(aes(col=Phylum))+facet_wrap(Family~OTU, scales="free",ncol=4)+theme_bw()+theme(panel.grid=element_blank())+theme(legend.position="bottom")+scale_color_brewer(palette="Set2")+labs(x="Dry beans (kg)")) # none convincing
```


# LeFSE: shade species
```{r}
library(microbiomeMarker)
# redefine filtered phyloseq object so only samples associated with shade trees are included
ps16S_filt <- filter_taxa(ps16S_samples, function(x) sum(x > 1) > 3, TRUE)
# only taxa present in at least 3 samples
mm16S <- lefse(ps16S_filt, 
  norm = 1e6, 
  class = "Shade_species", #variable to define classes
  multicls_strat = TRUE)

mm16S #17 markers
ldadf16S <- data.frame(mm16S@marker_table)

tax_split <- ldadf16S %>% 
  mutate(feature=str_replace_all(feature,"\\|","."))%>%
  separate(feature,into=c("Kingdom","Phylum","Class","Order",
                      "Family","Genus"),sep="\\.",extra="drop")%>%
  separate(Genus,into=c("Genus",NA),sep="\\-",extra="drop")%>%
  mutate(Kingdom=str_replace_all(Kingdom,"k__", ""))%>%
  mutate(Phylum=str_replace_all(Phylum,"p__", ""))%>%
  mutate(Class=str_replace_all(Class,"c__", ""))%>%
  mutate(Order=str_replace_all(Order,"o__", "")) %>%
  mutate(Family=str_replace_all(Family,"f__", ""))%>%
  mutate(Genus=str_replace_all(Genus,"g__", ""))

# a few have extra pieces
tax_split <- tax_split %>% separate(Genus,into=c("Genus",NA),sep="\\_",extra="drop")


ldaplotdf <-tax_split %>% group_by(Genus,enrich_group) %>% tally()
ldaplotdf$Genus <- ldaplotdf$Genus %>% replace_na("Unidentified")
sort <- ldaplotdf %>% group_by(Genus) %>% summarize(sort=sum(n)) %>% data.frame 

ldaplotdf <- ldaplotdf %>% merge(.,sort,by="Genus") %>% arrange(desc(sort))  # won't affect plot but lets us see which taxa are most abundant
ldaplotdf$Genus2 = with(ldaplotdf, reorder(Genus, sort, mean)) %>%as.factor() # reorders by most abundant order for plotting

(lda_plot16S <- ggplot(ldaplotdf,aes(x=enrich_group,y=Genus2,
          size=n))+geom_point(aes(color=enrich_group))+
    theme_bw()+ theme(panel.grid=element_blank())+
    scale_color_brewer(palette="BrBG")+
    theme(axis.text.x=element_text(angle=45,vjust=1,hjust=1))+
    labs(x=NULL,y=NULL, color= 
           "Enriched Near",size="# ASVs") + 
    theme(axis.text=element_text(size=12),
          axis.title=element_text(size=12))+
    theme(legend.position="bottom")+
    theme(legend.direction = "horizontal", legend.box = "vertical"))

#Genus not very useful because so few are identified at this level

 # creating column where last taxonomic identifier is attached to the ASV ID
features <- c(sprintf("ASV%1d", seq(1,17))) # generate list of IDs
rownames(tax_split) <- features

#identifying last value
tax_split <- tax_split %>% select(enrich_group,lda,pvalue,padj,everything())
lastValue <- function(x) tail(x[!is.na(x)], 1)
last_taxons<- apply(tax_split, 1, lastValue)
tax_split$last_taxon <- last_taxons
tax_split$final_names <- paste(features, tax_split$last_taxon, sep='-')

tax_split <- rename(tax_split,`Enriched Near`=enrich_group)

(lda_plot16S2 <- ggplot(tax_split,aes(x=reorder(final_names,-lda),y=lda,fill=`Enriched Near`))+
  geom_bar(stat="identity")+
    facet_grid(~`Enriched Near`,scales="free",space = "free")+
  scale_fill_brewer(palette="BrBG")+theme_bw()+
    theme(text=element_text(size=10))+
  theme(panel.grid=element_blank())+theme(axis.title.x=element_blank())+theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))+labs(y="LDA Effect Size") +
theme(strip.background = element_blank(),
  strip.text.x = element_blank())+theme(legend.position="bottom"))
```

# LEfSe - Fungi
```{r}
psITS_filt <- filter_taxa(psITS_samples, function(x) sum(x > 1) > 3, TRUE)
# only taxa present in at least 3 samples
mmITS <- lefse(psITS_filt, 
  norm = 1e6, 
  class = "Shade_species", #variable to define classes
  multicls_strat = TRUE)

mmITS #36 markers
ldadfITS <- data.frame(mmITS@marker_table)

tax_split <- ldadfITS %>% 
  mutate(feature=str_replace_all(feature,"\\|","."))%>%
  separate(feature,into=c("Kingdom","Phylum","Class","Order",
                      "Family","Genus"),sep="\\.",extra="drop")%>%
  separate(Genus,into=c("Genus",NA),sep="\\-",extra="drop")%>%
  mutate(Kingdom=str_replace_all(Kingdom,"k__", ""))%>%
  mutate(Phylum=str_replace_all(Phylum,"p__", ""))%>%
  mutate(Class=str_replace_all(Class,"c__", ""))%>%
  mutate(Order=str_replace_all(Order,"o__", "")) %>%
  mutate(Family=str_replace_all(Family,"f__", ""))%>%
  mutate(Genus=str_replace_all(Genus,"g__", ""))

# a few have extra pieces
tax_split <- tax_split %>% separate(Genus,into=c("Genus",NA),sep="\\_",extra="drop")


ldaplotdf <-tax_split %>% group_by(Genus,enrich_group) %>% tally()
ldaplotdf$Genus <- ldaplotdf$Genus %>% replace_na("Unidentified")
sort <- ldaplotdf %>% group_by(Genus) %>% summarize(sort=sum(n)) %>% data.frame 

ldaplotdf <- ldaplotdf %>% merge(.,sort,by="Genus") %>% arrange(desc(sort))  # won't affect plot but lets us see which taxa are most abundant
ldaplotdf$Genus2 = with(ldaplotdf, reorder(Genus, sort, mean)) %>%as.factor() # reorders by most abundant order for plotting

(lda_plotITS <- ggplot(ldaplotdf,aes(x=enrich_group,y=Genus2,
          size=n))+geom_point(aes(color=enrich_group))+
    theme_bw()+ theme(panel.grid=element_blank())+
    scale_color_brewer(palette="BrBG")+
    theme(axis.text.x=element_text(angle=45,vjust=1,hjust=1))+
    labs(x=NULL,y=NULL, color= 
           "Enriched Near",size="# ASVs") + 
    theme(axis.text=element_text(size=12),
          axis.title=element_text(size=12))+
    theme(legend.position="bottom")+
    theme(legend.direction = "horizontal", legend.box = "vertical"))

 # creating column where last taxonomic identifier is attached to the ASV ID
features <- c(sprintf("ASV%1d", seq(1,36))) # generate list of IDs
rownames(tax_split) <- features

#identifying last value
tax_split <- tax_split %>% select(enrich_group,lda,pvalue,padj,everything())
lastValue <- function(x) tail(x[!is.na(x)], 1)
last_taxons<- apply(tax_split, 1, lastValue)
tax_split$last_taxon <- last_taxons
tax_split$final_names <- paste(features, tax_split$last_taxon, sep='-')

tax_split <- rename(tax_split,`Enriched Near`=enrich_group)

(lda_plotITS2 <- ggplot(tax_split,aes(x=reorder(final_names,-lda),y=lda,fill=`Enriched Near`))+
  geom_bar(stat="identity")+
    facet_grid(~`Enriched Near`,scales="free",space = "free")+
  scale_fill_brewer(palette="BrBG")+theme_bw()+
    theme(text=element_text(size=10))+
  theme(panel.grid=element_blank())+theme(axis.title.x=element_blank())+theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))+labs(y="LDA Effect Size") +
theme(strip.background = element_blank(),
  strip.text.x = element_blank())+theme(legend.position="bottom"))
```


